Cофтпанорама 1990, No. 4 (8) ** ASM_CLUB **  Составитель: Н.Н. БЕЗРУКОВ
***********************************************************************
                                      Приводимые в данном разделе замет-
                                 ки  выражают  мнение авторов,  которое,
                                 естественно, может не совпадать с точ-
                                 кой зрения составителя.
***********************************************************************



                     ЗАПИСКИ  КОДОКОПАТЕЛЯ.


   Предлагается публиковать в данной рубрике (название пока  условное)
все, что можно охарактеризовать английским словом HINT, так или  иначе
относящееся к программированию на ассемблере. Это может быть  описание
недокументированных прерываний DOS и BIOS, нетривиальных  возможностей
программирования на ассемблере, решения всяких мелких  программистских
проблем  методом  "исправления  парочки  байтов".  Уверен,  что  часть
программистов  осудит  создание  такой  рубрики.  Это  будут поборники
полностью формализованного стиля программирования, любители Паскаля  и
поклонники Вирта.  Но действительно,  очень часто  встречаются случаи,
где не  помогут формальные  методы, и  необходимо дизассемблирование и
анализ кода  ( попробуйте  найти нужный  участок кода  в паре мегабайт
дизассемблера ! ),  умение исправлением пары байт решить задачу.

   В большинстве случаев такое умение требует довольно обширных знаний
-  номера  и  параметры  функций  DOS и BIOS, структура многочисленных
управляющих  блоков  и  т.д.  и  т.п.   В  процессе работы программист
постепенно накапливает большое  количество исправлений и  дополнений к
существующей  документации  -  это  и  есть  одна  из составных частей
программистского  опыта.  Так  давайте  поделимся  своими знаниями ! Я
думаю, что пользы  от этого будет  гораздо больше, чем  вреда от новых
компьютерных  вирусов,  которые  возможно  будут  написаны  читателями
данной рубрики.

   Предлагаю  провести  дискуссию  по  вопросам названия и содержимого
предлагаемой рубрики. А пока - несколько первых байт в нашу копилку.

------------------------------------------------------------------------------

*   Известный болгарский вирусолог  ( а , возможно, и автор  вирусов )
Весселин  Бончев  опубликовал  в  журнале  "Компьютер за вас" описание
нескольких  новых  вирусов,   появившихся   в   Болгарии.  Подробности
жизнедеятельности  вирусов   пусть  изучают   (  и   представляют   на
СОФТПАНОРАМЕ ) более компетентные вирусологи,  а я  приведу полученную
из этой статьи информацию о DOS и BIOS.

    Итак, при обращении к функции 013h прерывания 02Fh (DOS  Multiplex
Spooler Interrupt)  в регистрах  ES:BX возвращается  адрес, на которое
указывало прерывание 013h до загрузки DOS.  При проведении мною  более
подробного  исследования  выяснилось,  что  во-первых,  указатель   на
"старое"  тринадцатое  прерывание  возвращается   также  в  DS:DX,   а
во-вторых, эта функция не запрашивает информацию о прерывании 013h,  а
заменяет  старый  обработчик  тринадцатого  прерывания на новый, адрес
которого следует загрузить в эти пары регистров.

    Уточню, что  здесь речь  идет именно  об обработчике  тринадцатого
прерывания к которому будет обращаться DOS при его выполнении, а не  о
текущем указателе на тринадцатое прерывание в таблице векторов.

    В статье Бончева также указан весьма интересный адрес в ROM  BIOS,
который  справедлив  для  громадного  числа  машин  ( если не для всех
машин, хоть как-то  совместимых с IBM  PC ). Были  проверены несколько
машин AT, XT, "Мазовия",  "Искра" - для всех  результат положительный.
Итак : адрес прерывания 040h ( аналог прерывания 013h, функции те  же,
но обслуживает только флоппидисковые устройства ) равен F000:EC59.


*    Приведу небольшую  табличку :  что нужно  поменять в  программах,
входящих  в  комплект  Norton  Commanderа,  чтобы  они начали понимать
русскую букву "р".

Версия    Программа      Смещение(hex)   Было(hex)   Записать(hex)
------    ---------      -------------   ---------   -------------
2.0       NC.EXE         9CBD            E0          00
3.0       NCMAIN.EXE     1E02            E0          00
3.0       WPVIEW.EXE     36BE            E0          00
3.0       PARAVIEW.EXE   8BE6            E0          00
3.0       DBVIEW.EXE     2852            E0          00


*    На мартовской  СОФТПАНОРАМЕ я  ошибочно утверждал,  что если  при
лечении Norton  Disk Doctor  (NDD) "нормального"  раздела винчестера (
под Disk Managerом ) возникают сбои, то раздел можно расформатировапть
командой DOS FORMAT.   Это справедливо лишь  для раздела DOS  ( обычно
диск C ).

    При использовании  NDD возникают  обычно из-за  конфликтов с  Disk
Managerом два типа ошибок :  Boot Record Program is Invalid  и Invalid
Disk Table  in the  Boot record.   Первую ошибку  исправить достаточно
просто : используя Norton Utility переписать оригинальный Boot  сектор
исправляемого  диска  в  файл,  скопировать  на исправляемый диск Boot
сектор  из  загружаемого  раздела  винчестера  и  наконец восстановить
таблицу параметров  из сохраненного  файла (  таблица параметров диска
находится  в  байтах  Boot  сектора  начиная  с  0Bh  и  до байта 01Dh
включительно.   Метод исправления  второй ошибки  мне пока неизвестен,
однако эта ошибка возникает  лишь в разделах с  номером большим 3.  Он
связан с тем, что при анализе раздела NDD использует таблицу  разделов
винчестера, однако при этом  он не понимает нестандартных  таблиц Disk
Managerа ( для разделов 5 - 16 ). Позтому номера последнего  цилиндра,
дорожки, головки у NDD  неожиданно оказываются равными нулю,  вместе с
размером кластера в байтах ( хотя размер кластера в секторах верный ).
Если дать NDD отремонтировать такой  диск, то он будет испорчен  почти
безовзвратно.  Пока я  только могу рекомендовать использовать  в таком
случае программу CHKDSK, которая не анализирует таблицу разделов.

    Знание структуры Boot сектора может сослужить хорошую службу также
пользователям  программы  Advanced  Disk  Manager.  Они могут, изменяя
размер кластера  ( и,  соответственно, размеры  FAT )  в Boot  секторе
оптимизировать  использование  дискового  пространства  -  чем  меньше
кластер, тем меньше теряется места из-за дискретности выделения.


                                04.04.90 19:32

                                                  Свиридов И.А.
                                               д.т.(044) 263-87-70
                                           252127, Киев-127, а/я 804/7