
Глава 25. Совместимость с математическим сопроцессором
          387(ТМ), 80287 и 8087.
----------------------------------------------------------------

В данной главе обсуждаются проблемы, которые возникают при
переносе вычислительного программного обеспечения на процессор
i486 с более ранних систем. С точки зрения программного
обеспечения процессор i486 очень похож на системы 386(ТМ)
CPU/387(ТМ) FPU. Программное обеспечение, идущее на системе 386
CPU/387 NPX, вне зависимости от того, было ли оно написано для
этой системы или перенесено с систем 80286/80287 или 8086/8087,
будет выполняться и на процессоре i486. Для прямого перенесения
программ с систем 80286/80287 или 8086/8087 на процессор i486,
необходимо учитывать проблемы, описанные ниже. Каждый раздел
этой главы посвящен отличиям процессора i486 от каждого из его
предшественников.


25.1. Отличия от систем 386(ТМ) CPU/387(ТМ).
----------------------------------------------------------------

В этом разделе собраны те различия между процессором i486 и
системами 386 CPU/387 NPX, которые могут влиять на
численное программное обеспечение.

1. Биты регистра управления:

   Бит ET (Тип Расширения) регистра CR0 указывает на наличие в
   системе математического сопроцессора 80287 (ET = 0) или
   сопроцессора 387 DX (ET = 1). Аппаратурой процессора i486
   этот бит не используется. При перезапуске биту ET
   присваивается значение 0.

   Бит NE (Числовое Расширение) регистра CR0 используется
   процессором i486 для указания, должны ли немаскированные
   исключения с плавающей точкой передаваться как внутренние
   прерывания через вектор прерываний 16 (NE = 1) или как
   внешние прерывания (NE = 0). При перезапуске биту NE
   присваивается значение 0, следовательно программное
   обеспечение, использующее автоматический механизм сообщений
   об ошибках, должно устанавливать его равным 1.

   Для процессоров 80286 и 386 бит MP (Монитор Сопроцессора)
   регистра CR0 показывает, когда при наличии ловушки команды
   WAIT контекст FPU отличается от текущей работающей задачи.
   При MP = 1 и TS = 1 команда WAIT вызовет отказ из-за
   недоступности устройства (вектор прерываний 7). На
   микропроцессорах 80286 и 386 бит MP используется для
   поддержки комады WAIT при ожидании на устройствах, отличных
   от сопроцессора. Свой статус устройство сообщает через вывод
   BUSY#. Поскольку у процессора i486 нет такого вывода, бит MP
   не находит применения, и для нормальной работы перенесенных
   программ должен быть равен 1.

2. Инициализация и RESET.

   При перезапуске аппаратуры RESET регистры с плавающей точкой
   не изменяются до обращения к встроенной программе
   самотестирования (BIST). При обращении к BIST перезапуск
   RESET действует практически также, как команда FINIT.
   Единственное отличие состоит в том, что FINIT не изменяет
   регистры стека, а перезапуск RESET с BIST обнуляет их.

   При выполнении перезапуска RESET или команды FINIT
   математический сопроцессор 387 выдает сообщение об ошибке.
   Процессор i486 и сопроцессор 80287 этого не делают.

   Команда FINIT на процессоре i486 очищает указатели ошибок
   (данных и команд).

3. Исключения:

   На процессоре i486 неопределенный код операции ESC вызовет
   исключение неверного кода операции (вектор прерывания 6).
   Неопределенные коды операций ESC, также как и определенные,
   при установленном бите TS или EM в регистре CR0 вызывают
   исключение недоступности устройства (вектор прерывания 7).
   При обнаружении неопределенного кода операции ESC процессор
   i486 не делает проверки условий ошибки с плавающей точкой.

   Операнд невыровненных данных вызовет исключение выравнивания
   (вектор прерывания 17) на уровне 3 программного обеспечения.
   Исключение составляет операция FSAVE/FRSTOR над частью стека.

   На процессоре i486 команда WAIT может иногда выполняться как
   NOP. Это происходит в случае, когда команде WAIT предшествует
   команда, при выполнении которой осуществляется ожидание. В
   этом случае на процессоре i486 сообщение о числовом
   исключении может появиться на одну команду позже, чем на
   системе 386 CPU/387 NPX.

   На процессоре i486 при записи одной части операнда внутрь
   сегмента страницы, а другой - вне его, ошибка памяти может
   вызвать запись первой части без второй. В этом же случае
   системы 386 CPU/387 NPX ничего не запишут.

   На процессоре i486 при ошибке сегмента в середине операции
   FLDENV может случиться, что часть среды будет загружена, а
   часть - нет. В таких случаях в слове управления FPU останется
   значение 007FH.

   В процессоре i486 прерывание 9 отсутствует. В случаях, когда
   на процессоре 387 появляется прерывание 9, процессор i486
   просто прерывает выполнение команды. При этом, однако,
   необходима некоторая осторожность. Ошибки памяти (в
   особенности сбой страниц) при выполнении FLDENV или FRSTOR в
   случаях, когда операционная система осуществляет переключение
   задачи, могут вызвать потерю среды с плавающей точкой. Intel
   настоятельно рекомендует размещать область хранения с
   плавающей точкой на одной странице с TSS.

4. Трансцендентные команды:

   На процессоре i486 трансцендентные команды могут быть
   прерваны в некоторых контрольных точках во время выполнения,
   если INTR находится в состоянии ожидания. Таким образом,
   трансцендентные команды следует использовать только в среде,
   где появление INTR-ов ожидается не ранее, чем через 200
   тактов.


25.2  Отличия от систем 80286/80287.
----------------------------------------------------------------

В этом разделе собраны различия между процессором i486 и
системами 386 CPU/387 с одной стороны, и системами 80286/80287 и
8086/8087 с другой, и проанализировано влияние этих различий на
программное обеспечение, которое подлежит переносу с системы
80286/80287 на процессор i486. При любом прямом переносе с
систем 8086/8087 следует дополнительно принимать во внимание
соображения, описанные в Разделе 25.3


25.2.1	 Tипы данных и обработка исключений
----------------------------------------------------------------

┌─────────┬───────────────────────────────────────┬───────────────┬───────────┐
│         │          Описание  различий           │  Влияние на   │  Причина  │
│  Выход  ├──────────────────┬────────────────────┤  программное  │ различий  │
│         │ Поведение систем │ Поведение систем   │  обеспечение  │           │
│         │ i486 CPU/387 NPX │  80287/8087        │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│  NaN    │Системы i486 CPU/ │Системы 80287/8087  │Неинициализи-  │Совмести-  │
│(не-     │387 NPX различает │генирируют только   │рованный учас- │мость 754  │
│  число) │сигнальные и без- │один класс NaN(экви-│ток памяти, со-│стандарта  │
│         │ответные NaNы.    │валентный безответно│держащий QNaN─ы│IEEE.      │
│         │Системы i486      │му NaN), но вызывают│, которые дол- │           │
│         │CPU/387 NPX гене- │исключение неопреде─│ны быть измене-│           │
│         │рируют только без-│ленной операции при │ны на SNaN-ы,  │           │
│         │ответные NaN.Когда│возникновении любого│чтобы в систе- │           │
│         │встречается сиг-  │класса NaN.         │мах i486 CPU/  │           │
│         │нальные NaN-ы,    │                    │387 NPX возник-│           │
│         │генерируется искл.│                    │ла ошибка при  │           │
│         │неопределенной    │                    │обращении к не-│           │
│         │операции (исключе-│                    │инициализиро-  │           │
│         │не для FCOM, FIST,│                    │ванному участку│           │
│         │FBSTP, которые    │                    │памяти.        │           │
│         │вызывают IE для   │                    │               │           │
│         │безответных NaN). │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Псевдо-  │Системы i486 CPU/ │В системах 80287/   │Нет. Системы   │Совмести-  │
│ноль,    │387 NPX не генери─│8087 определены и   │i486 CPU/387 DX│мость 754  │
│Псевдо-  │руют и не поддер- │поддерживаются      │не генирируют  │стандарта  │
│NaN,     │живают такие фор- │специальные обработ─│эти форматы, и │IEEE.      │
│Псевдо-  │маты; при встрече │чики для таких      │следовательно, │           │
│бесконеч-│с ними в арифмети-│форматов.           │они не встретя-│           │
│ность и  │ческих операциях  │                    │тся если только│           │
│Ненорми- │возникает исключе─│                    │программист не │           │
│раванный │ние неопределенной│                    │намерен ввести │           │
│формат   │операции.         │                    │их.            │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Биты     │Кодирование в     │Кодирование для     │Обработчик     │Совмести-  │
│слова    │слове тега для    │псевдо-нуля и ненор-│исключений     │мость 754  │
│тега для │неподдерживаемых  │мированного-"дейст- │может нуждаться│стандарта  │
│неподдер-│форматов данных   │вительный" (тип 00);│в изменении,   │IEEE.      │
│живаемых │упоминается в     │другие-"специальные │если програм-  │           │
│форматов │Разделе 25.2.2    │данные" (тип 10).   │мист использует│           │
│данных   │"специальные      │                    │такие типы     │           │
│         │данные" (тип 10). │                    │данных.        │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Исключе- │Исключение неопре-│Возникает исключение│Нет. Програм-  │Улучшение, │
│ние неоп-│деленной операции │неопределенной опе- │мное обеспе-   │в результа-│
│ределен- │не возникает, ког-│рации, когда встре- │чение систем   │те которого│
│ной опе- │да встречается    │чаются денормали-   │i486 CPU/387   │не возника-│
│рации    │денормализованное │зованное число в    │NPX будет про- │ет исключе-│
│         │число в FSORT,FDIV│FSQRT, FDIV или     │должать выпол- │ние.       │
│         │или FPREM или при │FPREM или преобразо-│нятся в случаях│           │
│         │преобразовании BCD│вание BCD или целого│когда програм- │           │
│         │или целого. При   │                    │ное обеспечение│           │
│         │выполнении опера- │                    │систем 80287/  │           │
│         │ции вначале выпол-│                    │8087 попадет в │           │
│         │няется нормализа- │                    │ловушку.       │           │
│         │ция значения.     │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Исключе- │Исключение "денор-│Исключение "денорма-│Необходимость  │Повышение, │
│ние      │мализованное число│лизованное число" не│в изменении    │производи- │
│денорма- │возникает в транс-│возникает в транс-  │обработчика    │тельности  │
│лизован- │цендентных коман- │цендентных командах │исключений воз-│для норма- │
│ного     │дах и FXTRACT.    │и FXTRACT.          │никает только  │льного     │
│числа    │                  │                    │при специаль-  │случая.    │
│         │                  │                    │ной обработке  │           │
│         │                  │                    │различных кодов│           │
│         │                  │                    │операций.      │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Исключе- │Маскированное     │Маскированное исклю-│Маскированное  │Совмести-  │
│ние пере-│исключение пере-  │чение переполнения. │исключение     │мость 754  │
│полнения │полнения.         │                    │переполнения.  │стандарта  │
│         │                  │                    │               │IEEE.      │
│         │Если режим округ- │В системе 80287/8087│В большинстве  │           │
│         │ления установлен  │не возникает исклю- │обобщенных ок- │           │
│         │на отбрасывание   │чение переполнения, │ругляющих режи-│           │
│         │лишних цифр (по   │когда маскрованный  │мах роли не иг-│           │
│         │направлению к 0), │ответ не бесконеч-  │рает. При      │           │
│         │то результатом    │ность; т.е. сигнал  │отбрасывании   │           │
│         │будет число,      │переполнения возни- │лишних цифр (по│           │
│         │большее по модулю.│кает только когда   │направлению к  │           │
│         │                  │контроль округления │0) программа   │           │
│         │                  │не предусматривает  │систем i486 CPU│           │
│         │                  │округление нуля.    │/387 NPX, при  │           │
│         │                  │Если округление     │условии перепо-│           │
│         │                  │установлено на отб- │лнения выдает  │           │
│         │                  │расывание лишних    │результат, ко- │           │
│         │                  │цифр (по направлению│торый отлича-  │           │
│         │                  │к 0), то результатом│ется в послед- │           │
│         │                  │будет плюс или минус│нем значащем   │           │
│         │                  │бесконечность.      │бите мантиссы  │           │
│         │                  │                    │по сравнению с │           │
│         │                  │                    │результатом    │           │
│         │                  │                    │работы програм-│           │
│         │                  │                    │мы системы     │           │
│         │                  │                    │80287.         │           │
│         │                  │                    │               │           │
│         │Немаскированное   │Немаскированное     │Немаскированное│           │
│         │исключение пере-  │исключение перепол- │исключение     │           │
│         │полнения.         │нения.              │переполнения.  │           │
│         │                  │                    │               │           │
│         │Исключение точнос-│Исключение точности │При помещении  │           │
│         │ти помечено. При  │не помечено, и ман- │результата в   │           │
│         │помещении резуль- │тисса не округляется│стек, программа│           │
│         │тата в стек манти-│                    │систем i486 CPU│           │
│         │сса округляется   │                    │/387 NPX при   │           │
│         │согласно биту     │                    │условии пере-  │           │
│         │управления точно- │                    │полнения выдает│           │
│         │стью (PC) слова   │                    │результат,     │           │
│         │управления или    │                    │отличный от    │           │
│         │согласно коду     │                    │результата ра- │           │
│         │операции.         │                    │боты программы │           │
│         │                  │                    │систем 80287/  │           │
│         │                  │                    │8087. Отличие  │           │
│         │                  │                    │проявляется    │           │
│         │                  │                    │только при     │           │
│         │                  │                    │выполнении     │           │
│         │                  │                    │обработчика    │           │
│         │                  │                    │исключений.    │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Исключе- │Обстоятельства    │Обстоятельства      │Маскированное  │Совмести-  │
│ние отри-│отрицательного    │отрицательного      │исключение от- │мость 754  │
│цатель-  │переполнения.     │переполнения.       │рицательного   │стандарта  │
│ного пе- │                  │                    │переполнения.  │IEEE.      │
│реполне- │                  │                    │               │           │
│ния      │                  │                    │               │           │
│         │                  │                    │               │           │
│Два родс-│Когда исключение  │Когда исключение    │Нет влияния.   │           │
│твенных  │отрицательного    │отрицательного пере-│Исключение     │           │
│случая   │переполнения      │полнения маскирован-│отрицательного │           │
│вызывают │маскированно,     │но и округление     │переполнения   │           │
│отрицате-│возникновение сиг-│выполняется в сторо-│случается реже,│           │
│льное    │нала исключения   │ну 0, флаг исключе- │когда округле- │           │
│перепол- │происходит и когда│ния отрицательного  │ние выполняется│           │
│нение:   │результат очень   │переполнения устана-│по направлению │           │
│         │мал и когда при   │вливается на "кроше-│к 0.           │           │
│1. Возни-│денормализации    │чность" вне зависи- │               │           │
│   кает  │результата проис- │мости от потери     │Исключение     │           │
│"крошеч- │ходит потеря точ- │точности.           │отрицательного │           │
│ный" рез-│ности.            │                    │переполнения   │           │
│ультат.  │                  │                    │не маскированно│           │
│Крошечное│Отклик на отрица- │Отклик на отрицате- │               │           │
│число,по │тельное переполне-│льное переполнение. │При помещении  │           │
│причине  │ние.              │                    │результата в   │           │
│своей ма-│                  │                    │стек программа │           │
│лости,   │Когда исключение  │Когда исключение    │систем i486 CPU│           │
│может вы-│отрицательного    │отрицательного пере-│/387 NPX при   │           │
│звать не-│переполнения      │полнения не маски-  │условии отри-  │           │
│сколько  │немаскированно и  │рованно и адресатом │цательного     │           │
│других   │команда поддержи- │является стек, ман- │переполнения   │           │
│исключе- │вает сохранение   │тисса не округляется│выдает резуль- │           │
│ний (нап-│результата в стеке│, а остается как    │тат, отличный  │           │
│ример ис-│, мантисса округ- │есть.               │от результата  │           │
│ключение │ляется, для команд│                    │работы програм-│           │
│перепол- │контролируемых PC,│                    │мы систем 80287│           │
│нения при│с точностью, соот-│                    │/8087. Отличие │           │
│делении).│ветствующей точно-│                    │касается только│           │
│         │сти в бите управ- │                    │младшего знача-│           │
│2. Потеря│ления точностью   │                    │щего бита ман- │           │
│точности │(PC)слова управле-│                    │тиссы и сущест-│           │
│при дено-│ния, в других слу-│                    │венно только   │           │
│рмализа- │чаях, с повышенной│                    │для обработчика│           │
│ции кро- │точностью.        │                    │исключений.    │           │
│шечного  │                  │                    │               │           │
│числа.   │                  │                    │               │           │
│         │                  │                    │               │           │
│Какой    │                  │                    │               │           │
│из этих  │                  │                    │               │           │
│случаев  │                  │                    │               │           │
│приводит │                  │                    │               │           │
│в дейст- │                  │                    │               │           │
│вие иск- │                  │                    │               │           │
│лючение  │                  │                    │               │           │
│отрицате-│                  │                    │               │           │
│льное пе-│                  │                    │               │           │
│реполне- │                  │                    │               │           │
│ние зави-│                  │                    │               │           │
│сит от   │                  │                    │               │           │
│того ма- │                  │                    │               │           │
│скировано│                  │                    │               │           │
│   ли ис-│                  │                    │               │           │
│ключение.│                  │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Исключе- │Нет различий в    │Когда исключение    │Никакого, но   │Усовершен- │
│ние стар-│старшинстве исклю-│денормализации не   │в системах i486│ствование  │
│шинства  │чений денормализа-│маскировано,  задача│CPU/387 NPX    │операций   │
│         │ции в зависимости │имеет преимушество  │может мешать   │           │
│         │от того, маскиро- │старшинства над     │некоторым дено-│           │
│         │вано  ли исключе- │всеми другими исклю-│рмализованным  │           │
│         │ние или нет.      │чениями.            │операндам, не  │           │
│         │                  │                    │нуждающимся в  │           │
│         │                  │                    │нормализации   │           │
└─────────┴──────────────────┴────────────────────┴───────────────┴───────────┘


25.2.2  Слова тега, состояния и управления
----------------------------------------------------------------

┌─────────┬───────────────────────────────────────┬───────────────┬───────────┐
│         │          Описание  различий           │  Влияние на   │  Причина  │
│  Выход  ├──────────────────┬────────────────────┤  программное  │ различий  │
│         │ Поведение систем │ Поведение систем   │  обеспечение  │           │
│         │ i486 CPU/387 NPX │  80287/8087        │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Биты C3- │После FINIT, неза-│После FINIT, незаве-│  Никакого.    │Улучшено   │
│C0 слова │вершенной FPREM и │шенной FPREM и пере-│               │обеспечение│
│состояния│перезапуска аппа- │запуска аппаратуры, │               │согласован-│
│         │ратуры, эти биты  │системы 80287/8087  │               │ности сос- │
│         │устанавливаются в │оставляют эти биты  │               │тояния     │
│         │ноль.             │неизменными (содер- │               │после пере-│
│         │                  │жащими предыдущие   │               │загрузки.  │
│         │                  │значения).          │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Бит C2   │Бит 10 (C2) обслу-│Этот бит не опреде- │Никакого. Прог-│Улучшена   │
│слова    │живается как бит  │лен для FPTAN.      │раммы не прове-│возможность│
│состояния│незаверщенности   │                    │ряют C2 после  │быстрой    │
│         │для FPTAN.        │                    │FPTAN.         │проверки   │
│         │                  │                    │               │диапазона  │
│         │                  │                    │               │операнда.  │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Контроль │Поддерживается    │Поддерживаются и    │Программное    │Совместимо-│
│бесконе- │только аффинное   │аффинное и проекци- │обеспечение,   │сть 754    │
│чности   │замыкание. Бит 12 │онное замыкание.    │которое требует│стандарта  │
│         │остается програм- │После команды RESET │проецирования  │IEEE.      │
│         │мируемым, но не   │в слово управления  │арифметической │           │
│         │используется в    │проецируется значе- │бесконечности  │           │
│         │операциях.        │ние по умолчанию.   │может давать   │           │
│         │                  │                    │различные резу-│           │
│         │                  │                    │льтаты.        │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Бит 6    │Когда возникает   │Когда возникает иск-│Никакого.      │Внесенные и│
│слова    │исключение неопре-│лючение неопределен-│Существующие   │добавляемые│
│состояния│деленной операции │ной операции при    │обработчики    │улучшения. │
│при ошиб-│при переполнении  │переполнении или от-│исключений не  │           │
│ках стека│или отрицательном │рицательном перепол-│нуждаются в из-│           │
│         │переполнении стека│нении стека, то в   │менениях,но    │           │
│         │, то в слове сос- │слове состояния     │могут быть рас-│           │
│         │тояния устанавли- │устанавливается     │ширены  при ис-│           │
│         │вается не только  │только бит 0 (IE).  │пользовании    │           │
│         │бит 0 (IE), но и  │Бит 6 зарезервирован│дополнительной │           │
│         │биты 6 - показыва-│                    │информации.    │           │
│         │ет ошибку стека и │                    │               │           │
│         │9 (C1) - перепол- │                    │               │           │
│         │нение или отрица- │                    │               │           │
│         │тельное перепол-  │                    │               │           │
│         │нение. Бит 6      │                    │               │           │
│         │вызывается SF и   │                    │               │           │
│         │помогает разли-   │                    │               │           │
│         │чать,произошло ли │                    │               │           │
│         │исключение при    │                    │               │           │
│         │переполнении/     │                    │               │           │
│         │отрицательном пе- │                    │               │           │
│         │пеполненни стека  │                    │               │           │
│         │или в результате  │                    │               │           │
│         │операций над      │                    │               │           │
│         │числами.          │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Слово    │Когда с командами │Соответствующий тег │Программное    │Повышение  │
│тега.    │FLDENV или FRSTOR │проверяется перед   │обеспечение    │эффектив-  │
│         │загружается слово │каждым обращением к │может работать │ности      │
│         │тега, значение    │регистру для опреде-│неверно, если  │           │
│         │слова тега интерп-│ления класса операн-│используются   │           │
│         │ретируется только │да в регистре; тег  │команды FLDENV │           │
│         │как "пустое" (зна-│изменяется после    │или FRSTOR,    │           │
│         │чение 11) или     │каждого изменения   │изменяющие     │           │
│         │"непустое" (значе-│регистра так, что   │значения тегов │           │
│         │ния 00, 01 и 10). │тег отражает послед-│(отличные от   │           │
│         │Последующие опера-│нее состояние регис-│пустых) на от- │           │
│         │ции на непустом   │тра. Программист    │личные от соде-│           │
│         │регистре проверяют│может загружать тег │ржимого регист-│           │
│         │значение в регист-│с значением не соот-│ров.           │           │
│         │ре, но не значение│ветствующим содержи-│               │           │
│         │в теге. Команды   │мому регистра (нап- │               │           │
│         │FSTENV и FSAVE    │ример, в регистре   │               │           │
│         │проверяют непустой│находится законное  │               │           │
│         │регистр и помещают│содержимое, а тег   │               │           │
│         │верные значения в │говорит "специаль-  │               │           │
│         │теги перед сохра- │ное"; системы 80287/│               │           │
│         │нием слова тега.  │8087 в этом случае  │               │           │
│         │                  │отдают предпочтение │               │           │
│         │                  │тегу и не проверяют │               │           │
│         │                  │регистр).           │               │           │
└─────────┴──────────────────┴────────────────────┴───────────────┴───────────┘



25.2.3    Набор команд
----------------------------------------------------------------

┌─────────┬───────────────────────────────────────┬───────────────┬───────────┐
│         │          Описание  различий           │  Влияние на   │  Причина  │
│  Выход  ├──────────────────┬────────────────────┤  программное  │ различий  │
│         │ Поведение систем │ Поведение систем   │  обеспечение  │           │
│         │ i486 CPU/387 NPX │  80287/8087        │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FBSTP,   │Поддерживаются    │Операции с денорма- │Может требова- │Совместимо-│
│FDIV,    │операции с денор- │лизованным операндом│ться изменение │сть 754    │
│FIST(P), │мализованным опе- │вызывают исключение │обрабтчика иск-│стандарта  │
│FPREM,   │рандом. Может воз-│неопределенной опе- │лючений если   │IEEE.      │
│FSQRT    │никать исключение │рация. Отрицательное│дается различ- │           │
│         │отрицательного    │переполнение невоз- │ная обработка  │           │
│         │переполнения.     │можно.              │различным кодам│           │
│         │                  │                    │операций. Из-  │           │
│         │                  │                    │редка возможно │           │
│         │                  │                    │возникновение  │           │
│         │                  │                    │исключений нео-│           │
│         │                  │                    │пределенной    │           │
│         │                  │                    │операции.      │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FSCALE   │Коэффициент масшта│Коэффициент масштаби│Различный резу-│Повышение  │
│         │бирования операн- │рования операнда    │льтат когда    │производи- │
│         │да не ограничива- │ограничен. Если     │0<│ ST(1) │<1. │дельности. │
│         │ется. Если        │0 < │ ST (1) │ < 1, │               │           │
│         │0 < │ ST(1) │ < 1,│результат неопреде- │               │           │
│         │коэффициент масшта│лен и не возникает  │               │           │
│         │бирования ноль;   │исключения.         │               │           │
│         │поэтому ST(0) ос- │                    │               │           │
│         │тается без измене-│                    │               │           │
│         │ний. Если округле-│                    │               │           │
│         │нный результат не │                    │               │           │
│         │точен или произош-│                    │               │           │
│         │ла потеря точности│                    │               │           │
│         │(маскированное    │                    │               │           │
│         │отрицательное     │                    │               │           │
│         │преполнение) вызы-│                    │               │           │
│         │вается исключение │                    │               │           │
│         │точности.         │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FPREM1   │Выполняет согласо-│Не существует.      │Никакого.      │Совмести-  │
│         │вание остатка час-│                    │               │мость 754  │
│         │тного с стандартом│                    │               │стандарта  │
│         │754 IEEE.         │                    │               │IEEE и по- │
│         │                  │                    │               │вышение    │
│         │                  │                    │               │производи- │
│         │                  │                    │               │тельности. │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FPREM    │Биты C0, C3, C1   │Биты частного непра-│Никакого. Прог-│Повышение  │
│         │слова состаяния   │вильны, когда выпол-│раммное обеспе-│производи- │
│         │верно отображают  │няется уменьшение на│чение,обрабаты-│тельности. │
│         │три младших бита  │64**N + M,где N >= 1│вающее ошибку, │           │
│         │частного.         │,a M = 1 или М = 2. │не затрагива-  │           │
│         │                  │                    │ется.          │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FUCOM,   │Выполняют согласо-│Не существует.      │Никакого.      │Совместимо-│
│FUCOMP,  │вание неупорядоче-│                    │               │сть 754    │
│FUCOMPP  │нного сравнения со│                    │               │стандарта  │
│         │стандартом 754    │                    │               │IEEE.      │
│         │IEEE.             │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FPTAN    │Интервал значений │Интервал значений   │Никакого.      │Повышение  │
│         │операнда          │операнда ограничен  │               │производи- │
│         │слабо ограничен   │(│ST(0)│ < Пи/4);   │               │тельности. │
│         │(│ST(0)│ < 2**63);│интервал значений   │               │           │
│         │уменьшение операн-│операнда может быть │               │           │
│         │да внутреннее, с  │уменьшен использо-  │               │           │
│         │использованием    │ванием FPREM.       │               │           │
│         │внутренней конста-│                    │               │           │
│         │нты Пи/4,что повы-│                    │               │           │
│         │шает точность.    │                    │               │           │
│         │                  │                    │               │           │
│         │После переполнения│После переполнения  │               │Совместимо-│
│         │стека при маскиро-│стека  при маскиро- │               │сть 754    │
│         │ванном исключении │ванном исключении   │               │стандарта  │
│         │неопределенная    │неопределенной опе- │               │IEEE.      │
│         │операция  ST и    │рации, исходные опе-│               │           │
│         │  ST(1) содержат  │ранды остаются без  │               │           │
│         │скрытые NaN       │изменения, но содер-│               │           │
│         │                  │жимое ST(1) заносит-│               │           │
│         │                  │ся в стек.          │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FSIN,    │Выполнение трех   │Не существуют.      │Никакого.      │Повышение  │
│FCOS,    │общих тригономет- │                    │               │производи- │
│FSINCOS  │рических функций  │                    │               │тельности. │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FPATAN   │Интервал значений ││ST(0)│ должен быть │Никакого.      │Повышение  │
│         │операндов не огра-│меньше │ST(1)│      │               │производи- │
│         │ничен.            │                    │               │тельности. │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│F2XM1    │Расширен интервал │Поддерживается инте-│Никакого.      │Повышение  │
│         │операнда  (-1 <=  │рвал операнда       │               │производи- │
│         │ ST(0) <= +1)     │0 <= ST(0) <= 0.5.  │               │тельности. │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FLD      │Не выдает сообще- │Выдает сообщение о  │Никакого.      │Повышение  │
│веществе-│ние о исключении  │исключении денорма- │               │производи- │
│нного с  │денормализации,   │лизации.            │               │тельности. │
│расширен-│так как команда не│                    │               │           │
│ной точ- │арифметическая.   │                    │               │           │
│ностью   │                  │                    │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FXTRACT  │Eсли операнд ноль │Если операнд ноль,  │Никакого. Прог-│Рекоменда- │
│         │возникает сообще- │то ST(1) тоже ноль и│раммное обеспе-│ции IEEE   │
│         │ние об исключении │не возникает сообще-│чение обычно   │754 по пол-│
│         │деления на ноль и │ния об исключении.  │обходится нулем│нной подде-│
│         │ST(1) становится  │Если операнд + оо,  │и оо.          │ржке функ- │
│         │- оо. Если операнд│то появляется сооб- │               │ции logb   │
│         │+ оо, не возникает│щение об исключении │               │           │
│         │сообщения об иск- │неопределенной опе- │               │           │
│         │лючении.          │рации.              │               │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FLD      │Осуществляется    │Управление округле- │Результат будет│Рекоменда- │
│константы│управление округ- │нием не осуществля- │одинаков для   │ции IEEE   │
│         │лением.           │ется.               │систем 80287/  │754.       │
│         │                  │                    │8087, когда    │           │
│         │                  │                    │управление ок- │           │
│         │                  │                    │руглением уста-│           │
│         │                  │                    │новлено на ок- │           │
│         │                  │                    │угление к нулю,│           │
│         │                  │                    │- оо и (в слу- │           │
│         │                  │                    │чае FLDL2T) ок-│           │
│         │                  │                    │ругление к бли-│           │
│         │                  │                    │жайшему. При ок│           │
│         │                  │                    │руглении к +оо │           │
│         │                  │                    │и округлении к │           │
│         │                  │                    │ближайшему (за │           │
│         │                  │                    │исключением    │           │
│         │                  │                    │FLDL2T) резуль-│           │
│         │                  │                    │тат будет раз- │           │
│         │                  │                    │личаться в од- │           │
│         │                  │                    │ном из младших │           │
│         │                  │                    │значащих битов │           │
│         │                  │                    │мантиссы. Тот  │           │
│         │                  │                    │же результат   │           │
│         │                  │                    │будет для      │           │
│         │                  │                    │команд FLD1 и  │           │
│         │                  │                    │FLDZ.          │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FLD      │В случае загрузки │В случае загрузки   │Если следующими│Совмести-  │
│одинарной│денормализованного│денормализованного  │командами будут│мость 754  │
│/двойной │числа происхоит   │числа происходит его│FXTRACT или    │стандарту  │
│точности │его преобразование│преобразование в    │FXAM,системы   │IEEE.      │
│         │к расширенной     │ненормализованное.  │i486 CPU/387   │           │
│         │точности (так как │                    │NPX и 80287/   │           │
│         │его помещают в    │                    │8087 будут ра- │           │
│         │стек).            │                    │ботать по-раз- │           │
│         │                  │                    │ному.          │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FLD      │В случае загрузки │В случае загрузки   │Обработчик иск-│Совмести-  │
│одинарной│сигнального NaN-а,│сигнального NaN-а   │лючений нужда- │мость 754  │
│/двойной │возникает исклю-  │исключения не       │ется в модифи- │стандарту  │
│точности │чение неопреде-   │возникает.          │кации для обра-│IEEE.      │
│         │ленной операции.  │                    │ботки данного  │           │
│         │                  │                    │случая.        │           │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FSETPM   │Обрабатывется как │Информирует процес- │Никакого.      │CPU i486/  │
│         │FNOP (нет опера-  │сор 80287, что сис- │               │386 обраба-│
│         │ции).             │тема находится в    │               │тывают всю │
│         │                  │защищенном режиме.  │               │информацию │
│         │                  │                    │               │адресации и│
│         │                  │                    │               │исключений │
│         │                  │                    │               │как в заши-│
│         │                  │                    │               │щенном ре- │
│         │                  │                    │               │жиме так и │
│         │                  │                    │               │в незащище-│
│         │                  │                    │               │нном.      │
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│FXAM     │При анализе пус-  │Может генерировать  │Никакого.      │Усовершенс-│
│         │того регистра не  │эти комбинации      │               │твования,  │
│         │будет генерирова- │наравне с другими   │               │обеспечива-│
│         │ться в C0-C3 ком- │                    │               │ющие пов-  │
│         │бинация равная    │                    │               │торяемость │
│         │1101 или 1111.    │                    │               │результатов│
├─────────┼──────────────────┼────────────────────┼───────────────┼───────────┤
│Все тран-│Могут генерировать│Бит округления в    │Никакого.      │Усовершенс-│
│сценден- │различные резуль- │большую сторону     │               │твования   │
│тные ко- │таты в бите окру- │слова состояния     │               │состояний  │
│манды    │гления в большую  │неопределен для     │               │oкругления │
│         │сторону слова     │этих команд.        │               │сигнала.   │
│         │состояния.        │                    │               │           │
└─────────┴──────────────────┴────────────────────┴───────────────┴───────────┘



25.3  Отличия от систем 8086/8087.
----------------------------------------------------------------

Процессор i486, работающий в режиме реальных адресов, будет
выполнять программы процессора 8087 без существенной
модификации. Тем не менее, за счет различий в обработке
числовых исключений в процессоре i486 и 8087 NPX, процедуры
обработки исключений скорее всего должны будут измениться.
В этом разделе дается подробное описание того, как программы
процессора 8087 можно поставить на процессор i486.

1. Процессору 8087 требуется контроллер прерывания (8259А) для
   прерывания CPU при возникновении немаскированного исключения.
   Следовательно, все команды в обработчиках числовых прерываний
   процессора 8087, ориентированные на этот контроллер, должны
   быть уничтожены.

2. Команды FENI/FNENI и FDISI/FNDISI процессора 8087 не
   выполняют никакой полезной работы на процессоре i486.
   Если процесссор i486 обнаружит в потоке команд один из этих
   кодов операций, он будет проигнорирован - ни одно из
   внутренних состояний процессора не будет изменено.
   Если программа процессора 8087 будет выполняться
   на процессоре i486, процедуры обработки исключений,
   содержащие эти команды, вряд ли будут полностью переносимы.

3. В реальном и защищенном режимах (исключая виртуальный режим
   процессора 8086) вектор прерывания 16 должен указывать на
   процедуру обработки числового исключения. В виртуальном
   режиме процессора 8086 монитор V86 может быть
   запрограммирован с различным размещением векторов прерываний
   для числовых исключений.

4. Адрес программы ESC, записанный в процессоре i486, включает
   некоторые начальные префиксы перед кодом операции ESC.
   Соответствующий адрес в системе 8086/8087 не включает
   начальных префиксов.

5. В защищенном режиме процессора i486 (исключая виртуальный
   режим процессора 8086) формат хранимой команды и адресных
   указателей отличается от форматов, принятых в системе 8087.
   Код операции команды не сохраняется в защищенном режиме -
   при необходимости обработчики исключений должны
   восстанавливать его из памяти.

6. Прерывание 7 будет существовать в процессоре i486 при
   выполнении команд ESC, при установленных TS (переключение
   задачи) или EM (эмуляция) в MSW (TS = 1 или EM = 1).
   При установленном TS коанда WAIT тоже вызовет прерывание 7.
   Для обработки этих ситуаций в программу процессора i486
   следует включить обработчик исключений.

7. При попадании начального адреса числового операнда вне
   размера сегмента возникнет прерывание 13. Для сообщения
   об этой ошибке следует включить обработчик исключения.

8. Все числовые команды процессора i486 за исключением команд
   управления FPU синхронизируются автоматически -  процессор
   автоматически ждет перед выполнением следующий команды ESC,
   пока все операнды будут переданы. Для осущесттвления этой
   синхронизации не требуется явных команд WAIT. Для
   сопроцессора 8087, используемого с процессорами 8086 и 8088,
   явные команды WAIT требуются перед каждой числовой командой
   для осуществления синхронизации. Хотя программы с явными
   командами WAIT для процессора 8087 выполнятся правильно на
   процессоре i486 без реассемблирования, эти команды не нужны.

9. Поскольку процессору i486 не требуются команды WAIT перед
   каждой числовой операцией, ассемблер ASM386/486 не
   генерирует эти команды автоматически. Ассемблер же ASM86
   перед каждой командой ESC ставит команду WAIT. Хотя
   числовые процедуры, сгенерированные с использованием
   ассемблера ASM86, будут выполняться на процессоре i486
   правильно, реассемблирование с использованием ASM386/486
   даст, возможно, более компактный код и более быстрое
   выполнение.

   Команды управления для FPU процессора i486 могут быть
   кодированы как с использованием формы мнемоники WAIT,
   так и формы No - WAIT.
   Формы WAIT этих команд вызовут в ассемблере ASM386/486
   постановку команды WAIT перед каждой командой ESC, как
   это сделал бы ассемблер ASM86.

10. Адрес операнда памяти, записываемый командами FSAVE или
    FSTENV, будет неопределен, если предыдущая команда ESC
    не ссылалась на память.

11. Поскольку процессор i486 по возможности автоматически
    нормализует ненормализованные числа, программа процессора
    8087, использующая отдельно исключение денормализации для
    нормализации денормализованных операндов, может выполнятся
    на процессоре i486 при маскировании исключения
    денормализации. В этом случае обработчик исключения
    денормализации процессора 8087 не будет использоваться на
    процессоре i486. Числовая программа будет выполняться
    быстрее, если процессор i486 будет выполнять нормализацию
    денормализованных операндов.
