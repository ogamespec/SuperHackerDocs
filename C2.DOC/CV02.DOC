
                                     - 9 -
           
         

                                                        
                           2. ПЕРВОНАЧАЛЬНОЕ ЗНАКОМСТВО
                                                       
               
                                    СОДЕРЖАНИЕ
                                                               
                                                                     Лист
                                           
               2.     Первоначальное знакомство......................  9
               2.1.   Подготовка "C" программ........................ 10
               2.1.1. Требования к "C" программам.................... 10
               2.1.2. Компиляция "C" программ........................ 10
               2.1.3. Линкование объектных файлов.................... 11
               2.2.   Начальный запуск............................... 11
               2.3.   Стартовые опции................................ 13
               2.3.1. Старт в черно-белом режиме..................... 14
               2.3.2. Спецификация стартовых команд.................. 15
               2.3.3. Установка режима разделения экрана............. 15
               2.3.4. Установка оконного или последовательного режи-
                      ма диалога..................................... 16
               2.3.5. Отключение mouse'а............................. 17
               2.3.6. Переключение EGA-адаптера в 43-строчный режим.. 17
               2.3.7. Отладка с двумя дисплеями...................... 18
               2.3.8. Включение/выключение IBM-специфичных ловушек... 18
               2.4.   Работа CodeView с макроассемблером............. 18
           
           
.
                                      - 10 -
         
         
                
               2.1. Подготовка "C" программ
                
               Отлаживаемый  загрузочный  файл  должен  быть в специальном
         формате, содержащем информацию о номерах строк  и  таблицу  имен.
         Для  получения этого формата необходимо применять специальные оп-
         ции компилятора и линкера. Если загрузочный файл не  будет  иметь
         этой  информации, CodeView не сможет связать исходный текст с ад-
         ресами кода; программу можно будет отлаживать  только  на  уровне
         ассемблера, что существенно уменьшит возможности отладчика.
               В  п. 2.1.1 - 2.1.3 описаны требования к "C"программам, не-
         обходимые опции транслятора и линкера.
         
               
               2.1.1 Требования к "C"программам
                     
               Для удобства работы с CodeView требуется выполнять  следую-
         щие соглашения:
               1)  Программу  отлаживать  легче, если в исходном тексте на
         каждой строке находится не более одного  оператора.  Например,  в
         "C"строке:
               code=buffer[count];  if(code=='\n')++lines;  нельзя поставить
         точку останова на операторе ++lines;  или  if(code=='\n').  В  этом
         смысле фрагмент программы:
               code=buffer[count];
                   if(code=='\n')
                         ++lines;
         лучше.
               2) Макросы также затрудняют отладку. Не проблема, если мак-
         рос тривиален:
               #define sizmax 100
               Но отладка программы с макросом:
               #define ququ        do { \
                                       ++i;\
                                       } while(i<100);
         совсем не проста.
               Не  стоит пользоваться и include'ами, порождающими машинный
         код, так как отладчик не сможет связать include-файл с  выполняе-
         мым кодом; используйте include-файлы только для макросов. Если же
         текст  программы  состоит из нескольких файлов, оттранслируйте их
         отдельно и слинкуйте: CodeView поддерживает отладку  многомодуль-
         ных программ.
               ЗАМЕЧАНИЕ.
               Не  употребляйте в первых 128 байтах текста программы русс-
         кие буквы и графические символы. В некоторых  случаях  это  может
         стать серьезным препятствием (см. п. 3.1.3.1).

                                     
               2.1.2. Компиляция "C"программ
                           
               При  компиляции "C"программ под отладчик употребляйте опцию
         транслятора /Zi, заставляющую  компилятор  включать  в  объектный
         файл  информацию  о  номерах строк и создавать таблицу имен. Если
         таблица имен какого-то модуля не нужна, компилируйте этот  модуль
         с  ключем  /Zd.  Загрузочный  файл при этом будет занимать меньше

                                      - 11 -
         
         
         места в памяти и на диске, но при отладке этого модуля будут дос-
         тупны значения глобальных переменных и исходный текст; станут не-
         доступными только локальные переменные подпрограмм.
               Кроме того, вам, наверно, понадобится опция /Od,  выключаю-
         щая  оптимизацию.  Оптимизация повышает эффективность кода, но ее
         результатом может быть такое несоответствие кода и исходного тек-
         ста, которое сделает отладку практически невозможной.
               Пример:
                
               msc count /Zi /Od
                
               Эта компиляция подготовит объектный файл count.obj, увязан-
         ный с count.c.
                                                                          
               
               2.1.3 Линкование объектных файлов
                       
               При линковании объектных файлов под отладчик применяйте оп-
         цию /CODEVIEW (сокращенно /CO). Эта опция согласует адреса загру-
         зочного файла с таблицами имен и номерами строк файлов  исходного
         текста программы.
               Другие  опции  для  отладки не нужны, но можно употреблять,
         например, опции /MAP или /PAUSE.
               
               ПРЕДУПРЕЖДЕНИЕ.
               Не пользуйтесь опцией линкера /EXEPACK совместно с /CO, так
         как она убирает всю символьную информацию из загрузочного  файла.
         CodeView,  получив  упакованный файл, выдаст предупреждение и пе-
         реключится в ассемблерный режим; отладка в режиме исходного текс-
         та станет невозможна.
               Загрузочный файл, слинкованный с опцией /CO,  может  выпол-
         няться  MS-DOS'ом  как  и  любой  другой, но он будет значительно
         больше.
               Примеры.
               link /CO count
               cl /Zi /Od count.c
               Первый пример - линкование объектного файла, созданного
         компиляцией из предыдущего раздела. Линкер включит в загрузочный
         файл информацию для CodeView отладчика.
               Второй пример - совместная компиляция и линкование. Нет не-
         обходимости специфицировать /CO опцию, так как управляющая прог-
         рамма CL укажет ее автоматически, "увидев" опцию /Zi.
                
                                      
               2.2 Начальный запуск
                
               Перед началом работы убедитесь, все  ли  необходимые  файлы
         находятся на своих местах:
                
                Файл                       Место
                
                CV.EXE                CodeView    программа;    место
                                  нахождения -- текущий  каталог  или
                                  любой  каталог доступный по PATH'у.
                                  Если   MicroSoft   "C"   установлен

                                      - 12 -
         
         
                                  согласно   MicroSoft   C   Compiler
                                  User's Guide, то он должен  быть  в
                                  \BIN директории.
                                                    
                CV.HLP                Файл, который  содержит   меню-
                                  подсказки.    Если    вы     хотите
                                  пользоваться   help'ом   в процессе
                                  работы с отладчиком, то  этот  файл
                                  должен  находиться  либо  в текущем
                                  каталоге, либо  каталоге  доступном
                                  по   PATH'у.   Если  MicroSoft  "C"
                                  установлен  согласно  MicroSoft   C
                                  Compiler User's Guide, то он должен
                                  быть в \BIN  директории.  Если  при
                                  вызове подсказки отладчик не найдет
                                  этого   файла,   то    он    выдаст
                                  соответствующее сообщение.
                                 
             <Программа>.EXE          Загрузочный  файл "C"программы,
                                  которую вы  хотите  отлаживать;  ее
                                  местонахождение  -- текущий каталог
                                  или  диск и каталог,  который   был
                                  специфицирован при старте CodeView.
                                  Если  файл  не   найден,   CodeView
                                  выдаст   сообщение   об   ошибке  и
                                  закончит свою работу.
                                  
             <Программа>.C            Обычно  находится   в   текущем
                                  каталоге.     Однако,    если    вы
                                  специфицировали   место   исходного
                                  файла     при     компиляции,    то
                                  спецификация   становится    частью
                                  загрузочного файла, и отладчик ищет
                                  файл по этой спецификации.  Пример:
                                  при  компиляциии  MSC \C\DEMO, файл
                                  ищется в каталоге \C; MSC DEMO -- в
                                  текущем  каталоге. Если CodeView не
                                  находит  исходного  файла,  то   он
                                  запрашивает  путь к нему. Нажатие в
                                  ответ  Enter  говорит  о  том,  что
                                  исходный  текст  не нужен и отладка
                                  будет   производится    на   уровне
                                  ассемблера.
                                 
               Вызов отладчика осуществляется в формате:
               CV [<опции>] <спецификации файла> [<аргументы>], где <оп-
         ции> -- опции CodeView отладчика (см. п. 2.3), <спецификации фай-
         ла> -- имя .COM или .EXE файла с возможным к нему путем, а <аргу-
         менты> -- аргументы программы. При попытке загрузить невыполняе-
         мый файл CodeView заканчивает свою работу с сообщением:
               
               Not an executable file
                
               После линкования те "C" и ассемблерные программы, которые
         будут отлаживаться на уровне исходного текста, должны иметь рас-

                                      - 13 -
         
         
         ширение .EXE. Файлы с расширением .COM могут отлаживаться только
         в ассемблерном режиме. Программы с оверлеями не могут отлаживать-
         ся CodeView отладчиком.
               Если <спецификация файла> указывается без расширения, то по
         умолчанию берется расширение .EXE. Если файл не в CodeView форма-
         те, то CodeView распознает это, выдает сообщение:
                
               No symbolic information
           
         и переходит в ассемблерный режим.
               
               Пример вызова CodeView отладчика:
                
               CV sieve
         
               При работе на IBM компьютерах оконный режим устанавливается
         автоматически; на не-IBM-компьютере  по  умолчанию  будет  выбран
         последовательный  режим. Явное указание опций может переназначать
         режим, выбираемый при старте.
               Если ваша программа -- "C"программа, то CodeView автомати-
         чески переключится в режим исходного текста. В этом режиме необ-
         ходимо выполнить одну команду трассировки для выполнения инициа-
         лизирующей части программы и выхода на начало отлаживаемой прог-
         раммы.
                
                
               2.3. Стартовые опции
                
               Применяя стартовые опции, можно изменить режим,  в  котором
         будет работать CodeView после старта. Опции специфицируются с по-
         мощью  наклонной  '/'  или минуса '-'; имя отлаживаемого файла не
         должно содержать в себе этих символов. В командной  строке  можно
         задавать  более  одной опции, но они дожны быть согласованы между
         собой.
               Примечание.
               CodeView не анализирует  различия  между  компьютерами,  он
         распознает IBM компьютер, опрашивая PS-DOS.
               Далее описаны ситуации, в которых могут понадобиться опции:
                       
                               Если                           То
                
                Вы имеете  IBM-совместимый компьютер          /W
                и хотите работать в оконном режиме.
                                     
                Вы имеете одноцветный дисплей, цветной        /B
                графический  адаптер (CGA),  IBM  или
                IBM-совместимый  компьютер и   хотите
                отлаживать черно-белую программу.
                
                Вы отлаживаете графическую программу          /S
                и хотите  просматривать экран вывода
                программы.
                
                Вы отлаживаете программу, использующую
                многостраничность  дисплея,  и  хотите        /S

                                      - 14 -
         
         
                просматривать экран вывода программы.
                
                Вы   работаете  на   не-IBM-совместимом
                компьютере и хотите просматривать экран       /S
                вывода программы.
                
                Вы работаете с IBM-совместимым компью-
                тером  и  отлаживаете   программы,  не        /F
                пользующиеся  графикой и многостранич-
                ностью экрана.
                
                Вы  имеете  IBM  компьютер,  но хотите        /T
                отлаживаться в последовательном режиме.
                
                Вы имеете mouse, но не хотите им поль-        /M
                зоваться в отладчике.
                
                Вы хотите 43-строчный режим дисплея и
                ваш компьютер имеет Графический адап-         /43
                тер высокого разрешения (EGA).
                
                Вы хотите чтобы CodeView отладчик вы-          /C
                полнил серию команд при старте.
                
                Вы имеете 2 видеоадаптера и дисплея и          /2
                хотите  один из  них сделать дисплеем
                вывода.
                
                Выключение  IBM-специфичных   функций
                (таких  как   CTL+C,  CTL+BREAK)  для          /D
                IBM-плохосовместимых компьютеров.
                
                Расширение возможностей отладчика IBM-         /I
                специфическими  функциями   (CTL+C  и
                CTL+BREAK).

                
               2.3.1. Старт в черно-белом режиме
                
               Опция:
                
               /B : -B
                
               /B  опция  позволяет  отлаживать  черно-белые программы при
         цветном  адаптере  и  дисплее. По умолчанию CodeView при загрузке
         
           
           
         проверяет  тип  адаптера  и  если  обнаруживает  MA (монохромный)
         адаптер, то работает в двух цветах, а если находит  CGA  (цветной
         графический адаптер), то работает в многоцветном режиме.
               В  связи  с  тем, что многие двухцветные дисплеи изображают
         цвета полутонами, использование /B опции улучшит наглядность тек-
         ста.
               

                                      - 15 -
         
         
               Пример.
                
               CV /B count count.txt
           
         запуск отладки программы в черно-белом режиме.
                
                         
               2.3.2. Спецификация стартовых команд
                
                Опция:
                
               /C<команды> : -C<команды>
                
               /C опция специфицирует одну или несколько  команд,  которые
         будут  выполнены  при старте (рекомендовано использование /C сов-
         местно с MAKE и BATCH файлами). Каждая команда должна быть  отде-
         лена от следующей ';'.
               Предупреждение.
               Если  одна  или  более  команд имеют аргументы, разделенные
         пробелами, то вся опция должна быть заключена в  двойные  кавычки
         '"'. Иначе CodeView будет интерпретировать этот аргумент как сле-
         дующую опцию командной строки.
               Если  одна или более команд имеют аргументы, содержащие '<'
         или '>', то вся опция должна быть  заключена  в  двойные  кавычки
         '"'. Иначе MS-DOS будет интерпретировать их как свои команды.
               Примеры.
               CV /CGmain count count.txt
               CV "/CS-;n16;G countwords;D buffer L100" count count.txt
               CV "/C<input.fil" count count.txt
               Первый  пример загружает CodeView с count.exe и ее аргумен-
         том count.txt. При старте  выполняется  команда  G  с  аргументом
         main.
               Во  втором  примере при старте выполняются команды: S- (от-
         ладка в режиме ассемблера), n16 -- назначение работы  CodeView  в
         шестнадцатеричном  радиксе  (системе  исчисления), G counwords --
         выполнение программы до вызова countwords и т.д.
               В третьем случае при  старте  CodeView  отладчик  выполняет
         список  команд  из  файла  INPUT.FIL так, как будто они введены с
         клавиатуры. Команда без кавычек была бы MS-DOS'овской -- переназ-
         начением стандартного ввода с клавиатуры.
           
                                      
           
               2.3.3. Установка режима разделения экрана
                
               Опции:
                
               /F : -F
               /S : -S
                
               CodeView поддерживает два независимых экрана: экран отладки
         и экран вывода программы. Это делается двумя  путями:  с  помощью
         флипинга  (опция  /F) и с помощью свопинга (опция /S). Флипинг --
         это разделение экранов CodeView и отлаживаемой  программы  с  по-
         мощью  страниц  дисплейной  памяти (CV использует вторую страницу

                                      - 16 -
         
         
         памяти, начинающуюся с адреса 0xB8800 (?)), а свопинг -- разделе-
         ние экранов с помощью специльного буфера в памяти.
               Флипингом нельзя пользоваться при отладке графических прог-
         рамм, при использовании MA адаптера, на IBM-несовместимых  компь-
         ютерах.
               Свопинг  не  так  ограничен, как флипинг, но он медленнее и
         занимает больше памяти под буфер экрана (4K для MA, 16K для CGA и
         EGA).
               По умолчанию флипинг включается на IBM компьютерах с графи-
         ческими адаптерами (CGA и EGA), а свопинг -- при использовании MA
         адаптера.
               Если графическая программа была вызвана без  опции  /S,  то
         при включении графики CodeView выдаст предупреждение:
               Video mode changed without /S option
                
               Таблица 2.1. Зависимость режима работы CodeView от типа
         компьютера, адаптера и /F и /S опций
           
         -----------------------------------------------------------------
            Компьютер   Адаптер   Умалчиваемый        Альтернативный
                                        режим                режим
        ------------------------------------------------------------------
            IBM       CGA или EGA    /F/W     /S, если ваша программа
                                              использует  графику или
                                              страницы дисплея;
                                              /T -  последовательный
                                               режим.
            IBM-сов-     CGA или      /T      /W -  оконный  режим;
            местимый       EGA                /F использование  флип-
                                              инга или /S свопинга.
            IBM          MA          /S/W     /T для последовательного
                                              режима.
            IBM-сов-     MA           /T      /W для оконного режима;
            местимый                          /S для свопинга.
            IBM-несов-
            местимый     любой        /T      /S для свопинга.
               
               Если у вас IBM-совместимый  компьютер,  проведите  экспери-
         мент, и если БСВВ (BIOS) вашего компьютера не совместим с IPC, то
         CodeView не сможет работать с /S и /F опциями.
               CodeView игнорирует /F опцию на компьютерах с MA адаптером.
               Примеры.
                
               CV /F count count.txt
               CV /S grafix
                
               Первый  пример  -- запуск CodeView с текстовой программой в
         флипинге, второй -- запуск графической программы в свопинге.

                
               2.3.4. Установка оконного или последовательного режима диа-
         лога
                
                Опции:
                

                                      - 17 -
         
         
               /T : -T
               /W : -W
                
               CodeView отладчик может работать либо в оконном (/W),  либо
         в  последовательном  (/T) режиме диалога. В оконном режиме четыре
         окна позволяют видеть различные аспекты  отлаживаемой  программы;
         использование  mouse'а  облегчает  работу. Последовательный режим
         допускает работу с любым компьютером  и  полезен  переназначением
         команд; в нем вывод отладочной информации на экран осуществляется
         последовательно.  Более  детально  поведение CodeView в различных
         режимах описано в главе 3 "CodeView экран". Выбор режима в  зави-
         симости от конфигурации компьютера описан в табл. 2.1.
               Поэкспериментируйте  с  этими  опциями.  Если  BIOS  вашего
         компьютера не совместим с IPC, вы не сможете пользоваться /W  оп-
         цией.
               
               Примечание.  Любой  CodeView оператор, выполнимый в оконном
         режиме, может быть выполнен в последовательном.
               Примеры:
                
               CV /W sieve
               CV /T sieve
                
               Первый пример -- вызов CodeView в оконном режиме, второй --
         в последовательном.
                             
               
               2.3.5. Отключение mouse'а
                
               Опция:
                
               /M : -M
               
               Если вы инстоллировали mouse, но не хотите им  пользоваться
         в  отладчике,  применяйте опцию /M. Эта опция необходима либо при
         отладке программ, использующих mouse,  либо  при  несовместимости
         вашего mouse'а с MicroSoft mouse'ом.
               
               Замечание.
               Конфликт  между  программой  и отладчиком за mouse разрешим
         при версии драйвера 5.02  и  более.  Последняя  версия  MOUSE.SYS
         (MOUSE.COM) включена в MicroSoft"C" дистрибутивный диск.
               
               
               2.3.6. Переключение EGA адаптера в 43-строчный режим
                
               Опция:
                
               /43 : -43
                
               При  наличии  EGA  адаптера стартовая опция /43 переключает
         экран в текстовый режим 43 строки по 80 символов.  Эта  опция  не
         работает на CGA или MA адаптере.
               Режим  43x80  (вместо стандартного 25x80) позволяет размес-
         тить на экране больше текста, но делает его менее читабельным.
                

                                      - 18 -
                      
               
               Пример:
                      
               CV /43 count count.txt
                
               Этот пример -- старт CodeView в 43-строчном режиме.
               Если EGA адаптар отсутствует, опция будет проигнорирована.
                
                
               2.3.7. Отладка с двумя дисплеями
                
               Опция:
                 
               /2
                
               Эта опция разрешает использовать при отладке 2 дисплея. Ваш
         компьютер обязан иметь 2 адаптера и 2 дисплея. Программа работает
         с текущим дисплеем и адаптером, а отладчик -- с  альтернативными.
         Например,  если на вашем компьютере установлены графический (CGA)
         и монохромный (MA) адаптеры, для отладки графической программы на
         два дисплея установите командой MS-DOS'а CGA текущим  дисплеем  и
         вызовите  CodeView.  После  этого вывод программы будет осуществ-
         ляться на текущий дисплей (CGA), а вывод отладчика --  на  монох-
         ромный.
               Эта опция запрещает использование mouse'а дисплеем отладчи-
         ка.
                
               2.3.8. Включение/выключение IBM-специфичных ловушек
                
               Опции:
                
               /D : -D
               /I : -I
                
               Употребление этих опций позоляет регулировать использование
         в  отладчике  таких  специфичных  функций  как CTL+C и CTL+BREAK,
         включаемых NMI и 8259 маскированием. Опция /D  запрещает  их  ис-
         пользование,  если  это мешает отладке или BIOS вашего компьютера
         их не допускает. Последовательный режим выбирается при этом авто-
         матически; для включения оконного режима применяйте  совместно  с
         /D опцию /W.
               Опция  /I  усиливает  отладчик  IBM-специфичными  функциями
         (CTL+C,  CTL+BREAK),  которые  CodeView   отладчик   отменяет  на
         на  IBM-плохосовместимых  компьютерах.  Оконный  режим  при  этом
         выбирается автоматически; нет необходимости употреблять опцию /W.
                
                
               2.4. Работа CodeView с макроассемблером
                
               Можно использовать CodeView для отладки  файлов,  подготов-
         ленных  MicroSoft (или IBM) Макроассемблерами. Так как MASM (вер-
         сия 1.0-4.0) не записывает номера строк в объектный файл, некото-
         рые CodeView возможности не могут быть использованы  при  отладке
         ассемблерных программ.
               CodeView  может применяться для отладки .EXE и .COM файлов,
         но просмотр символьной информации возможен только в .EXE  файлах.
         Алгоритм отладки ассемблерных .EXE файлов следующий:

                                      - 19 -
         
         
               1) объявите в вашем исходном ассемблерном файле имена (мет-
         ки,  переменные),  используемые  в отладке, как PUBLIC. Если файл
         мал, можете оPUBLIC'овать все имена;
               2) проассемблируйте файл; нет необходимости  в  специальных
         опциях и все опции разрешены;
               3)  слинкуйте файл линкером, поступившим с MicroSoft"C" 4.0
         (не пользуйтесь другими), употребив при этом опцию /CODEVIEW;
               4) отлаживайте программу в  ассемблерном  режиме  (CodeView
         перейдет в него при старте автоматически, не обнаружив информации
         о  номерах  строк).  В  процессе отладки можно работать только на
         уровне ассемблера, но  есть  возможность  просматривать  исходный
         текст  программы, предварительно загрузив его в окно отладки. Это
         удобно, если нужно прочитать макрос или комментарий. Все метки  и
         переменные,  оPUBLIC'ованные в исходном файле в режиме ассемблера,
         видны как имена вместо адресов.
               Эта  процедура  может  использоваться  для отладки процедур
         C-библиотеки времени выполнения, ассемблерные тексты которых даны
         на SOURСE диске,  или  ассемблерных  модулей,  выполняемых  вашей
         "C"программой.
                
