                
                                     - 73 -
                               
                
                5. СВЕДЕНИЯ О ФУНКЦИОНИРОВАНИИ 

     
                         5.1 Введение

     Характерной    чертой    80386   является   наличие   простого
функционального интерфейса для взаимосвязи с внешними модулями.
     В 80386 имеются  две  раздельные  шины:  шина  адреса  и  шина
данных. Шина данных - 32-разрядная и двунаправленная. В большинстве
применяемых модулей для высококоростной локальной шины используются
32 разряда адреса, передаваемого по адресной шине, из них 2 младших
разряда дешифрируются в 4 сигнала строба  данных  (каждый  из  этих
сигналов  разрешает  или  запрещает передачу соответствующего байта
данных), а остальные 30 разрядов представляют  собой  двоичный  код
адреса.  Для  управления  обменом  по  шине  адреса  и  шине данных
используются соответствующие управляющие сигналы.
     Изменяемая  ширина   (разрядность)   шины   данных   позволяет
процессору  взаимодействовать  как  с  32-х,  так и с 16-разрядными
внешними шинами в синхронном режиме (см. 5.3.4).
     Если передача информации состоит из нескольких циклов  обмена,
каждый  из  которых требует 16-разрядной ширины шины данных, то все
равно 80386  в  каждом  цикле  автоматически  выполнит  необходимую
процедуру  установления  разрдности  шины. *-разрядные периферийные
устройства могут быть подключены к 32-х или 16-разрядным шинам, при
этом  их производительность не снижается. В 80386 применяется новый
режим конвейерной адресации, который обеспечивает в случае  32-х  и
16-разрядной   шин   наиболее  рациональное  использование  памяти,
особенно это  проявляется  в  очень  напряженном  режиме  работы  с
ресурсами  памяти  (когда  доступ к памяти требуется большому числу
абонентов). 
     Режим  конвейерной  адресации по сравнению с другими способами
адресации значительно сокращает время нахождения интерфейса  памяти
в   состоянии   ожидания   (см.   5.4.2).   Конвейерную   адресацию
целесообразно применять в системах, имеющих в своем составе  память
с  расслоением.  В системах с рабочей частотой 16 МГц, включающих в
себя  память  с  расслоением   со   временем   обращения   100   Нс
(динамические  ОЗУ),  можно  совсем  исключить  состояние ожидания,
применяя конвейерную  адресацию.  Когда  внешние  модули  потребуют
режим  конвейерной  адресации,  80386  сформирует адрес и определит
длительность цикла шины для предстоящего цикла шины (если позволяют
внутренние ресурсы), даже если в настоящий момент процессор ожидает
подтверждение в текущем цикле.
     Однако,   неконвейеризированный   способ   адресации  идеально 
подходит для устройств, в состав которых входит кэш-память, так как 
высокое    быстродействие    кэш-памяти    позволяет   работать   в 
неконвейеризированном режиме. Для обеспечения максимальной гибкости 
системы  на  основе  совмещения циклов конвейерный способ адресации 
применяется в синхронных системах. 
     Цикл  шины  процессора  является  основным  средством передачи
информации из системы в процессор или из процессора в систему.
     Минимальная длительность цикла передачи данных по шине в 80386
состовляет  два периода тактовой частоты. Поскольку процессор 80386
имеет 32-разрядную  шину  данных  и  рабочую  частоту  16  МГц,  то
следовательно  максимальная пропускная способность 80386 составляет
32 Мбайт/сек. Однако, длительность любого  цикла  шины  может  быть
увеличена,  если  в  этом  цикле задерживается выдача подтверждения
обмена  от  внешнего  модуля.  В  соответствующий  момент   времени
подтверждение  выдается  путем  формирования сигнала на входе READY
(ГОТОВ) процессора 80386.
     80386 может терять доступ к своим локальным  шинам,  передавая

                                     - 76 -
           
           
управление   ими  другим  устройствам,  например,  каналам  прямого
доступа к памяти. При этом,  за  исключением  единственного  выхода
HLDA,  формируемого  80386,  обеспечивается  почти  полная изоляция
процессора от системы. Изолязия процессора необходима при  передаче
управления    тестовому   оборудованию   или   в   отказоустойчивых
применениях  (в многопроцессорных системах для изоляции отказавшего
процессора и замены его другим).
     В   данном   разделе   представлены   сведения  об  интерфейсе
процессора.  Во-первых,  описано  назначение  и   функции   выводов
процессора   (см.  5.2  Описание  сигналов).  Кроме  того,  описаны
изменения сигналов в течение циклов шины (см. 5.3  Механизм  обмена
по  шине,  5.4 Описание функционирования шины и 5.5 Другие сведения
по функционированию). 
     
     
                    5.2 Описание сигналов

                        5.2.1 Введение

     Подраздел  начинается  с  краткого описания входных и выходных
сигналов 80386, объединенных в функциональные группы. Отметим,  что
наличие  символа  #  после  названия сигнала означает, что активное
состояние сигнала - состояние низкого  уровня.  И  наоборот,  когда
такого  символа # нет после названия сигнала, то сигнал активен при
высоком уровне.
     Пример обозначения сигнала: M/IO#
             - Высокий уровень означает обращение к памяти.
             - Низкий  уровень  означает  обращение  к  устройствам
               ввода/вывода.   
     В  описаниях сигналов встречаются иногда обозначения временных
параметров, таких как "t25  Reset/Setup  Time"  (Время  сброса  при
включении питания) и "t26 Reset Hold Time" (Время удержания сигнала
сброса). Значения этих параметров приведены в табл.7-4  и табл.7-5.
     
     
                       5.2.2 Синхросигнал (CLK2)

     CLK2 обеспечивает основную  синхронизацию  работы  80386.  Эта 
тактовая  частота  делится  пополам  для  того,  чтобы сформировать 
внутреннюю  процессорную   тактовую   частоту,   используемую   при 
выполнении   команд   внутри  процессора.  Внутренний  синхросигнал 
состоит из двух фаз: "фазы один"  и  "  фазы  два".  Каждый  период 
частоты.  На рис.5-2 показано соотношение двух синхросигналов. Если 
необходимо,   фаза    внутреннего    синхросигнала    может    быть 
синхронизирован  от  такого  отрицательного  фронта  сигнала RESET, 
который обеспечит заданные времена установки и удержания, t25 и t26 
(setup and hold times). 
     
     
                       5.2.3 Шина данных (D0-D31)

     Двунаправленные   с   тремя   состояниями  линии  шины  данных 
обеспечивают перемещение данных  от  80386  к  другим  устройствам. 
Наличие  высокого  уровня  напряжения на входах/выходах шины данных 
обозначает наличие кодов логической единицы "1"  на  этих  выводах. 
Шина   данных  может  передавать  данные  как  на  32-,  так  и  на 
16-разрядные шины благодаря тому, что  есть  возможность  изменения 
размера  шины  данных;  размер  шины  данных определяется значением 
входного сигнала BS16# (см. параграф 5.2.6 Шина управления). 
     Для правильного выполнения операций считывания сигналов с шины
данных требуется обеспечение необходимых значений времени установки

                                     - 77 -
           
           
t21 и времени удержания t22 считываемых данных.
     При   любой   операции   записи   (включая  циклы  останова  и
выключения) 80386 всегда передает все 32 разряда данных, даже  если
в текущем цикле размер шины обмена равен 16 разрядам.
     
     
               5.2.4 Шина адреса (BE0#-BE3#, A2-A31)

     Эти   выходы   с  тремя  состояниями  обеспечивают  физическую 
адресацию памяти или адресацию устройств ввода/вывода. Шина  адреса 
обеспечивает  физическое  пространство  адресов  памяти  объемом  4 
гигабайта  (от  00000000H  до  FFFFFFFFH)  и  пространство  адресов 
ввода/вывода  объемом  64 килобайта (от 00000000H до 0000FFFFH) для 
обращения  к  устройствам  ввода/вывода.   Для   передачи   сигалов 
ввода/вывода,    автоматически    формируемых    для    обеспечения 
взаимодействия  80386  с   сопроцессором,   используется   адресное 
пространство  ввода/вывода  от  800000F8H до 800000FFH, так как для 
обращения  к  сопроцессору  необходимо  совпадение  двух   условий: 
наличие  высокого  уровня  напряжения на линии адреса А31 и наличие 
низкого уровня на линии M/IO#. 
     Значения  сигналов   стробов   данных   BE0#-BE3#   определяют 
соответственно те байты 32-разрядной шины данных, которые участвуют 
в текущей  передаче.  Это  особенно  удобно  для  взаимодействия  с 
внешней аппаратурой. 
     BE0# определяет участие в обмене разрядов D0-D7,
     BE1#                 -"-                  D8-D15,
     BE2#                 -"-                  D16-D23,
     BE3#                 -"-                  D24-D31.
     Количество  стробов  данных  BE0#-BE3#, находящихся в активном
состоянии, определяет размер операнда обмена (1,2,3  или  4  байта)
(см. параграф 5.3.6 Выравнивание данных).
     Когда  выполняется  цикл  записи  в  память  или  в устройство
ввода/вывода, и передаваемый операнд  занимает  только  старшие  16
разрядов  шины  данных (D16-D31), копия этого операнда одновременно
передается  по  младшим  16  разрядам  шины  данных  (D0-D15).  Это
дублирование выполняется для обеспечения оптимального режима записи
на  16-разрядные  шины.  Процедура дублирования записываемых данных
зависит от значений стробов данных BE0#-BE3#.
.
                                     - 78 -
           
           
     Таблица 5-1. Зависимость дублирования записываемых данных
                           от значений BE0#-BE3#
-------------------------------------------------------------------
Стробы данных 80386|Записываемые данные 80386   |Есть ли автомати-
------------------------------------------------|ческое дублирова-
BE3#|BE2#|BE1#|BE0#|D24-D31|D16-D23|D8-D15|D0-D7|    ние?
-------------------------------------------------------------------
выс.|выс.|выс.|низ.|неопр. |неопр. |неопр.|  А  |      нет
-------------------------------------------------------------------
выс.|выс.|низ.|выс.|неопр. |неопр. |  В   |неопр|      нет
-------------------------------------------------------------------
выс.|низ.|выс.|выс.|неопр. |   С   |неопр.|  С  |      да
-------------------------------------------------------------------
низ.|выс.|выс.|выс.|   D   |неопр. |  D   |неопр|      да
-------------------------------------------------------------------
выс.|выс.|низ.|низ.|неопр. |неопр. |  В   |  А  |      нет
-------------------------------------------------------------------
выс.|низ.|низ.|выс.|неопр. |   С   |  В   |неопр|      нет
-------------------------------------------------------------------
низ.|низ.|выс.|выс.|   D   |   С   |  D   |  С  |      да
-------------------------------------------------------------------
выс.|низ.|низ.|низ.|неопр. |   С   |  В   |  А  |      нет
-------------------------------------------------------------------
низ.|низ.|низ.|выс.|   D   |   С   |  В   |неопр|      нет
-------------------------------------------------------------------
низ.|низ.|низ.|низ.|   D   |   С   |  В   |  А  |      нет
-------------------------------------------------------------------
                    
     Обозначения: D=логические записываемые данные в байте D24-D31;
                  C=                -"-                    D16-D23;
                  B=                -"-                    D8-D15;
                  A=                -"-                    D0-D7.
     
     
            5.2.5 Сигналы определения типа цикла шины 
                      (W/R#, D/C#, M/IO#, LOCK#)
     
     Эти выходы с тремя состояниями определяют тип  текущего  цикла
шины.  В  зависимости  от значения W/R# все циклы подразделяются на
циклы записи и циклы чтения. D/C#  разделяет  все  циклы  на  циклы
обмена   данными  и  циклы  обмена  управляющими  сигналами.  M/IO#
отличает циклы обращения к памяти от циклов обращения к устройствам
ввода/вывода.  По  сигналу  LOCK# различаются циклы с блокированной
шиной. 
     Основными сигналами определения типа цикла шины являются W/R#,
D/C# и M/IO#, так как эти сиганлы принимают действительное значение
одновременно  с  установлением активного уровня сигнала ADS# (выход
строба   адреса).    Действительное    значение    сигнала    LOCK#
устанавливается  тогда,  когда начинается цикл шины (причем, цикл с
конвейерной  адресацией)  и  после  установления  активного  уровня
сигнала ADS# (см. параграф 5.4.3.4 конвейерная адресация).
     Точное соответствие типов циклов шины значениям сигналов W/R#,
D/C# и  M/IO#  приведено   в   табл.5-2.  Отметим  одну  комбинацию
сигналов W/R#, D/C# и M/IO#, которая никогда не может быть получена
при активном уровне сигнала ADS# (однако, эта  комбинация,  которая
обозначена   как   "запрещенная"  может  иметь  место  в  нерабочих
состояниях шины, при неактивном  уровне  сигнала  ADS#).  Поскольку
действительные  значения  сигналов  M/IO#, D/C# и W/R# определяются
временем действия сигнала ADS#, то в другое время для  оптимального
использования  дешифрирующей схемы можно использовать и запрещенную
комбинацию.
.
                                     - 79 -
           
           
             Таблица 5-2. Определение типа цикла шины
-------------------------------------------------------------------
 M/IO# | D/C#  | W/R#  |   Тип цикла шины            | Блокирована
       |       |       |                             | ли шина?
-------------------------------------------------------------------
низкий |низкий |низкий | Подтверждение прерывания    |    да
-------------------------------------------------------------------
низкий |низкий |высокий| Запрещенная                 |    да
-------------------------------------------------------------------
низкий |высокий|низкий | Чтение данных из устройства |    нет
       |       |       | ввода/вывода                |
-------------------------------------------------------------------
низкий |высокий|высокий| Запись данных в устройство  |    нет
       |       |       | ввода/вывода                |
-------------------------------------------------------------------
высокий|низкий |низкий | Чтение команды из памяти    |    нет
-------------------------------------------------------------------
высокий|низкий |высокий| Останов:       Выключение:  |    нет
       |       |       | Адрес=2        Адрес=0      |
       |       |       | --------       -----------  |
       |       |       | (BE0#Выс.      (BE0#Низк    |
       |       |       |  BE1#Выс.       BE1#Выс.    |
       |       |       |  BE2#Низк.      BE2#Выс.    |
       |       |       |  BE3#Выс.       BE3#Выс.    |
       |       |       |  A2-A31Низк.)   A2-A31Низк.)|
-------------------------------------------------------------------
высокий|высокий|низкий | Чтение данных из памяти     | Некоторые
       |       |       |                             | циклы
-------------------------------------------------------------------
высокий|высокий|высокий| Запись данных в память      | Некоторые
       |       |       |                             | циклы
-------------------------------------------------------------------
     
     
                 5.2.6 Сигналы управления шиной
     
                        5.2.6.1 Введение

     Нижеперечисленные  сигналы  позволяют  процессору   определять
начало  цикла  шины,  а  также  дают возможность другим устройствам
системы управлять конвейерной адресацией, размером  шины  данных  и
определять конец цикла шины.
     
     
                   5.2.6.2 Строб адреса (ADS#)

     Этот  входной сигнал с тремя состояниями на входе указывает на
то  что  на  выводах  80386  установлены  действительные   значения
сигналов,  определяющих  тип  цикла  шины, и сигналов адреса (W/R#,
D/C#, M/IO#, BE0# - BE3# и A2-A31). Сигнал  ADS  устанавливается  в
течение тактов Т1 и Т2  состояний шины (дополнительную информацию о
состояниях  шины  см.  5.4.3.2  Неконвейеризированная  адресация  и
5.4.3.4 Конвейерная адресация). 
     
     
              5.2.6.3 Сигнал подтверждения (READY#).

    Этот вход указывает на то, что текущий цикл шины завершен, и те
байты,  участие  которых  в  цикле  обмена  определено   значениями
BE0#-BE3#  и  BE16#,  приняты  или  переданы. Когда в течение цикла

                                     - 80 -
           
           
чтения или  цикла  подтверждения  прерывания  формируется  активный
уровень  сигнала  READY#,  80386  "защелкивает"  входные  данные  и
завершает цикл. Когда сигнал READY#  формируется  в  цикле  записи,
процессор завершает цикл шины.
     Сигнал  READY#  игнорируется  в первом такте всех циклов шины,
затем в каждом такте состояние READY# опрашивается до тех пор, пока
не  установится активный уровень сигнала READY#. READY# должен быть
сформирован для подтверждения в каждом цикле  шины,  включая  циклы
отображения  останова  и  отображения  выключения.  Для  правильной
работы время установки t19 и время  удержания  t20  сформированного
сигнала  READY# должны иметь определенные необходимые значения (См.
все параграфы раздела 5.4 Описание функционирования шины).
     
     
              5.2.6.4 Запрос следующего адреса (NA#)

     Этот сигнал используется  для  запрашивания  адреса  в  режиме
конвейерной  адресации.  Этот  вход  сообщает процессору о том, что
система готова принять из 80386 новые значения сигналов  BE0#-BE3#,
A2-A31,  W/R#, D/C# и M/IO#, даже если завершение текущего цикла не
подтверждено сигналом READY#.
     Если 80386 обнаружит на входе NA# активный уровень, он  выдает
на   шину   следующий  адрес,  обеспечив  внутреннюю  подготовку  к
следующему запросу шины (см. параграф 5.4.2 Конвейерная адресация и
5.4.3 Циклы чтения и записи).
     
     
            5.2.6.5 Указатель 16-разрядной шины (BS16#)
     
     Благодаря  сигналу BS16# осуществляется непосредственная связь
80386  с  32-разрядной  и  16-разрядной  шинами  данных.  Установка
активного уровня этого  входа  приведет к тому, что в текущем цикле
шины обмен будет производиться  только  по  младшей  половине  шины
данных (D0-D15) в соответствии со значениями сигналдов BE0# и BE1#.
Дополнительное влияние сигнала  BS16#  (установленного  в  активное
состояние) не проявится, если в текущем цикле сформированы активные
уровни только сигналов  BE0#  или  BE3#,  действие  сиганала  BS16#
(активного  уровня)  заставит процессор 80386 выполнить необходимые
переключения для  правильной  передачи  старшего(их)  байта(ов)  по
линиям D0-D15.
     Если  операнд  занимает  обе  половины  шины  данных и BS16# в
активном  состоянии,  то  80386   автоматически   выполнит   второй
16-разрядный цикл шины. Для правильной работы время установки t17 и
время  удержания  t18  сигнала  BS16#  должны  иметь   определенные
необходимые значения.
     Циклы   ввода/вывода,   автоматически  выполняемые  80386  для
взаимосвязи с сопроцессором, не требуют  установки  сигнала  BS16#.
Сопроцессоры  типа  80287 и 80387 анализируют входной сигнал ERROR#
сразу после отрицательного фронта сигнала RESET. 80386 обменивается
только  16-разрядными  посылками с 80287, а в случае взаимодействия
80386 с сопроцессором 80387 обмен производится только 32-разрядными
посылками. Таким образом, значение BS16# влияет на циклы с участием
80287, а в течение циклов с  участием  80387  сигнал  BS16#  должен
поддерживаться на неактивном уровне. 
                

                                     - 81 -
     
     
                  5.2.7 Сигналы арбитража шины
     
                        5.2.7.1 Введение
          
     В   этом  разделе  описывается  механизм,  благодаря  которому
процессор  передает  управление  своими  локальными  шинами  другим
активным абонентам, запрашивающим урпавление шиной (см. 5.5.1).

                 5.2.7.2 Запросы на захват шины (HOLD)

     Этот  выход  указывает  на  то, что каким-то устройствам кроме
80386 требуется управление шиной.
     Сигнал HOLD  должен  поддерживаться  в  активном  состоянии  в
течение  всего  времени,  пока  любое  другое  устройство  является
владельцем  локальной  шины.  Сигнал  HOLD  игнорируется  во  время
действия  RESET.  Если  сигнал  RESET  появится  во  время действия
сигнала HOLD, то более приоритетный сигнал RESET установит  шину  в
нерабочее    состояние    быстрее,    чем   установится   состояние
подтверждения захвата шины (состояние высокого сопротивления).
     Процессор срабатывает по фронту  сигнала  HOLD  и,  пока  HOLD
поддерживается  в активном состоянии, постоянно анализирует уровень
этого сигнала.  Вход  HOLD  -  синхронизированный.  Для  правильной
работы  время  установки  t23  и  удержания t24 должны всегда иметь
определенное необходимое значение.
     
             5.2.7.3 Подтверждение захвата шины (HLDA)

     Формирование активного уровня на выходе HLDA указывает на  то,
что  80386  передает  управление  своей  локальной шиной в ответ на
установление   сигнала  HOLD  и переходит в состояние подтверждения
захвата шины.
     Состояние  подтверждения  захвата  предполагает  почти  полную
изоляцию  процессора.  Сигнал  HLDA в этом состояние - единственный
сигнал,  выдаваемый   80386.   Другие    выходные    сигналы    или
двунаправленные  сигналы  (D0-D31,  BE0#-BE3#,  A2-A31, W/R#, D/C#,
M/IO#, LOCK# и ADS#)  переключаются  в  третье  (высокоимпедансное)
состояние,  поэтому запросившее шину устройство может захватить их.
К некоторым сигнальным линиям желательно  подсоединить  фиксирующие
резисторы  для  того,  чтобы  избежить  ложное срабатывание по этим
сигналам, когда они не формируются  текущим  владельцем  шины  (см.
7.2.3  Рекомендации по выбору и применению резисторов). Кроме того,
один используемый фронт, который может быть  сформирован  на  входе
NMI  во  время состояния подтверждения захвата, запоминается с тем,
чтобы он был проанализирован и обработан после снятия сигнала HOLD.
Кроме  обычного  использования  состояния подтверждения захвата при
взаимодействии 80386 с контроллерами ПДП (прямого доступа к памяти)
или  активными  периферийными  устройствами, состояние почти полной
изоляции  процессора  особенно   удобно   использовать   в   режиме
тестирования   системы,    когда  тестовое  оборудование  управляет
системой, а также в отказоустойчивых системах.

                                     - 82 -
                
     
              5.2.8 Сигналы интерфейса с сопроцессором

                           5.2.8.1 Введение

     В следующих параграфах этого раздела дано  описание  сигналов,
предназначенных  для интерфейса с арифметическим сопроцессором. Эти
сигналы, дополняя  сигналы  шины  данных,  шины  адреса  и  сигналы
определения  типа цикла шины, управляют взаимодействием 80386 с его
сопроцессором 80287 или 80387. 
     
     
                 5.2.8.2 Запрос сопроцессора (PEREQ)

     Активный   уровень   этого   сигнала   указывает  на  то,  что
сопроцессор требует, чтобы в ответ на его  запрос  операнды  данных
были переданы в/из памяти.
     Активный  уровень  этого  входного сигнала указывает на запрос
сопроцессора на передачу процессором  80386  операнда  данных  в/из
памяти,  в  ответ  на  этот  запрос 80386 передает информацию между
сопроцессором и памятью. Поскольку в 80386 хранится  код  операции,
выполняемой  сопроцессором, 80386 осуществляет запрошенную передачу
данных в заданном нарпавлении и по заданному адресу  памяти.  80386
анализирует  и  срабатывает  по  уровню сигнала PEREQ. Сигнал PEREQ
может быть асинхронным по отношению к CLK2. 
     
     
                 5.2.8.3 Сопроцессор занят (BUSY#)
     
     Активный   уровень   этого   сигнала   указывает  на  то,  что
сопроцессор еще выполняет заданную текущую  инструкцию  и  пока  не
может принять другую инструкцию.
     Когда  80386  встречает любую инструкцию сопроцессора, которая
оперирует  с  арифметическим  стеком  (стеком  сопроцессора)  (т.е.
инструкции   загрузки,   "рор"  -  инструкции (убрать  в  стек) или
арифметические операции), или инструкцию ожидания  WAIT,  он  сразу
автоматически  анализирует состояние входного сигнала BUSY# и будет
просматривать  его  до  тех  пор,  пока  BUSY#  не  переключится  в
неактивное состояние. 
     Такой    просмотр   входного   сигнала   BUSY#   предотвращает
преждевременную выдачу следующей  инструкции  во  время  выполнения
сопроцессором предыдущей инструкции.
     Инструкция  сопроцессора  FNINIT и FNCLEX могут быть выполнены
даже  при  наличии  активного  уровня  на  входе  BUSY#,  так   эти
инструкции   используются  для  инициализации  и  прерывания-сброса
сопроцессора.
     80386 анализирует  и  срабатывает  по  уровню  сигнала  BUSY#.
Сигнал BUSY# может быть асинхронным по отношению к CLK2.
     Сигнал   BUSY#   служит   еще   одной   цели.  Если  во  время
отрицательного фронта сигнала RESET на входе BUSY#  имеется  сигнал
низкого  уровня,  то  80386 выполнит процедуру самодиагностирования
(см. 5.5.3 Функционирование шины в течение и после действия сигнала
RESET).  Если  же  в  этот  момент сигнал BUSY# будет иметь высокий
уровень, то самодиагностирование выполняться не будет.

                                     - 83 -
     
     
               5.2.8.4 Ошибка сопроцессора (ERROR#)
     
     Этот входной  сигнал  указывает  на  то,  что  при  выполнении
сопроцессором  предыдущей инструкции им был сформирован код ошибки,
немаскируемый управляющим регистром  сопроцессора.  При  выполнении
сопроцессором  инструкции процессор 80386 автоматически анализирует
входной сигнал ERROR#, и если установится активный уровень  сигнала
ERROR#,  то  80386  вырабатывает  прерывание  7, чтобы обратиться к
программам обработки ошибок.
     Некоторые инструкции  сопроцессора,  в  основном  те,  которые
сбрасывают флаги арифметических ошибок в сопроцессоре или сохраняют
состояние сопроцессора, исполняются без выработки процессором 80386
прерывания  7,  даже  если  установлено  активное состояние сигнала
ERROR#.  К  таким  инструкциям  относятся  FNINIT,  FNCLEX,  FSTSW,
FSTSWAX, FSTCW, FSTENV, FSAVE, FESTENV и FESAVE.
     80386  анализирует  и  срабатывает  по  уровню сигнала ERROR#.
Сигнал ERROR# может быть асинхронным по отношению к CLK2.
     Сигнал ERROR# выполняет еще одну функцию. Если низкий  уровень
сигнала ERROR# установится не позже, чем через 20 периодов тактовой
частоты  CLK2  после  отрицательного  фронта   сигнала   RESET,   и
сохранится  таким  по меньшей мере до тех пор, пока 80386 не начнет
свой первый цикл шины, то  это  указывает  на  то,  что  в  системе
используется  сопроцессор  типа  80387  (разряд  ET  в регистре CR0
автоматически устанавливается в 1). В  обратном  случае  в  системе
используется  сопроцессор  типа  80287  или не используется никакой
(разряд ET в регистре CR0 автоматически устанавливается в  0).  См.
5.5.3  Функционирование  шины  в  течение  и после действия сигнала
RESET. Изменение сигнала  на  выходе  ERROR#  влияет  на  установку
только  бита  ET.  Программно  устанавливаются необходимые значения
битов EM и MP в регистре CR0. Следовательно, для различения  случая
наличия  в  системе  сопроцессора  типа  80287  от  случая, когда в
системе вообще нет  сопроцессора,  необходимо  программное  задание
соответствующего   значения  бита  EM  в  регистре  CR0  (единичное
значение бита EM устанавливается в  случае,  когда  в  системе  нет
сопроцессора).  Если  анализ  изменения  состояния  сигнала  ERROR#
показал наличие в системе 80387 (сигнал ERROR установлен  в  низкое
состояние   после   сброса),   но  позднее  программно  установлено
единичное состояние бита EM (EM=1), то 80386 ведет  себя  так,  как
если бы в системе не было сопроцессора.
     
                     5.2.9 Сигналы прерывания

                          5.2.9.1 Введение

     В  этом  разделе  описываются  входные  сигналы, которые могут
прерывать  или  приостанавливать  выполнение  процессором  текущего
набора инструкций.
     
            5.2.9.2 Маскируемый запрос прерывания (INTR)

     Активный  уровень  этого входного сигнала обозначает запрос на
обслуживание прерывания, которое может быть замаскировано битом  IF
флагового  регистра  Flag Register 80386. В ответ на входной сигнал
INTR 80386 выполняет два цикла подтверждения прерывания и  в  конце
второго  цикла  "защелкивает" 8-битовый вектор прерывания, принятый
по линиям D0-D7, чтобы идентифицировать источник прерывания.  80386
анализирует  уровень  и  срабатывает по уровню сигнала INTR. Сигнал
INTR может быть асинхронным по отношению к CLK2.  Для  того,  чтобы
гарантировать    опознание    процессором    маскируемого   запроса
прерывания, активный уровень сигнала INTR должен поддерживаться  до
начала первого цикла подтверждения прерывания.

                                     - 84 -
     
     
           5.2.9.3 Немаскируемый запрос прерывания (NMI)

     Этот   входной   сигнал   определяет  запрос  на  обслуживание
прерывания, которое не может быть программно замаскировано.  Запрос
немаскируемого прерывания всегда обрабатывается по программе, адрес
начала которой указан в элементе (позиции)  2  таблицы  прерываний.
Когда  обрабатывается  NMI,  то  благодаря  фиксированному значению
позиции   таблицы   прерываний,    соответствующей    NMI,    циклы
подтверждения прерывания не выполняются.
     80386   анализирует и  срабатывает  по  положительному  фронту
сигнала NMI. Сигнал NMI  может  быть  асинхронным  по  отношению  к
сигналу  CLK2. Чтобы гарантировать опознание сигнала NMI, последний
должен иметь неактивный уровень  по  меньшей  мере  в  течение  8-и
периодов  CLK2,  и  затем  должен  быть установлен и поддерживаться
активный уровень сигнала NMI по меньшей мере в течение 8-и периодов
CLK2.
     Как только начинается обработка запроса прерывания NMI, другие
запросы  NMI  обрабатываться  не  будут  до   появления   очередной
инструкции  IRET,  которая  означает  конец  процедуры обслуживания
прерывания NMI. Однако, если все-таки раньше  этого  времени  снова
будет   сформирован   активный   уровень   сигнала   NMI,  то  один
положительный фронт сигнала  NMI  будет  запомнен  для  последующей
обработки после выполнения очередной инструкции IRET. 
     
     
     5.2.9.4  Сигнал сброса (установки в исходное состояние)(RESET) 

     Этот входной сигнал останавливает выполнение любой операции  и
переводит  80386 в состояние, известное как состояние сброса. Сброс
80386 производится установкой  активного  уровня  сигнала  RESET  в
течение 15-и или более периодов CLK2 (за 78 или более периодов CLK2
до запроса самодиагностирования). Когда установлен активный уровень
сигнала   RESET,   сигналы   на   всех  остальных  входных  выводах
игнорируются, а шинные выводы переводятся в нерабочее состояние как
показано в табл.5-3. Если  одновременно установлены активные уровни
сигналов RESET и HOLD, то более приоритетным  будет  сигнал  RESET.
Сброс  по сигналу RESET будет произведен, даже если 80386 находился
в состоянии подтверждения захвата до установки RESET.
     80386 анализирует  и  срабатывает  по  уровню  (активному  или
неактивному)  сигнала RESET. Сигнал RESET может быть асинхронным по
отношению с CLK2. Если необходимо, фаза  внутреннего  синхросигнала
процессора,  а  также  целое  состояние  80386 могут быть полностью
синхронизированы с внешними схемами,  если  обеспечить  необходимые
для  этого  значения  времени установки t25 и времени удержания t26
отрицательного фронта сигнала RESET.
.
                                     - 85 -
           
           
        Таблица 5-3   Состояние выводов (неработающей шины)
                        в течение действия сигнала RESET

-------------------------------------------------------------------
  Обозначение выводов     |  Уровни сигналов во время сброса RESET
-------------------------------------------------------------------
           ADS#           |            Высокий
-------------------------------------------------------------------
          D0-D31          | Третье состояние (высокий импеданс)
-------------------------------------------------------------------
        BE0#-BE3#         |            Низкий
-------------------------------------------------------------------
          A2-A31          |            Высокий
-------------------------------------------------------------------
           W/R#           |            Высокий
-------------------------------------------------------------------
           D/C#           |            Высокий
-------------------------------------------------------------------
          M/IO#           |            Низкий
-------------------------------------------------------------------
          LOCK#           |            Высокий
-------------------------------------------------------------------
           HLDA           |            Низкий
-------------------------------------------------------------------
                        
.
                                     - 86 -
           
           
                     5.2.10   Список сигналов
    
     В табл.5-4  перечислены сигналы процессора 80386  и  приведены
некоторые их характеристики.
     
              Таблица 5-4    Перечень сигналов 80386
     
-------------------------------------------------------------------
 Название|   Функции   | Активный| Вход/ | Вход      | Переключает-
  сигнала|   сигнала   |  уровень| выход | синхронный| ся ли выход
         |             |         |       | или асинх-| в третье
         |             |         |       | ронный по | (высокоимпе-
         |             |         |       | отношению | дансное)
         |             |         |       | к CLK2    | состояние во
         |             |         |       |           | время дейст-
         |             |         |       |           | вия HLDA?
-------------------------------------------------------------------
  CLK2   |Синхросигнал |    -    | Вход  |     -     |      -
-------------------------------------------------------------------
 D0-D31  |Шина данных  | Высокий | Вход/ |     S     |     да
         |             |         | выход |           |
-------------------------------------------------------------------
BE0#-BE3#|Стробы данных| Низкий  | Выход |     -     |     да
-------------------------------------------------------------------
 A2-A31  |Шина адреса  | Высокий | Выход |     -     |     да
-------------------------------------------------------------------
  W/R#   |Указатель ре-| Высокий | Выход |     -     |     да
         |жима записи  |         |       |           |
         |или чтения   |         |       |           |
-------------------------------------------------------------------
  D/C#   |Указатель об-| Высокий | Выход |     -     |     да
         |мена данными |         |       |           |
         |или упр. сиг-|         |       |           |
         |налами       |         |       |           |
-------------------------------------------------------------------
 M/IO#   |Указатель об-| Высокий | Выход |     -     |     да
         |ращения к па-|         |       |           |
         |мяти или В/В |         |       |           |
-------------------------------------------------------------------
  LOCK#  |Блокировка   | Низкий  | Выход |     -     |     да
         |шины         |         |       |           |
-------------------------------------------------------------------
   ADS#  |Строб адреса | Низкий  | Выход |     -     |     да
-------------------------------------------------------------------
   NA#   |Запрос сле-  | Низкий  | Вход  |     S     |     да
         |дующего адре-|         |       |           |
         |са           |         |       |           |
-------------------------------------------------------------------
  BS16#  |16-разрядная | Низкий  | Вход  |     S     |     да
         |ширина шины  |         |       |           |
-------------------------------------------------------------------
 READY#  |Передача     | Низкий  | Вход  |     S     |     да
         |подтверждения|         |       |           |
-------------------------------------------------------------------
  HOLD   |Запрос на за-| Высокий | Вход  |     S     |     да
         |хват шины    |         |       |           |
-------------------------------------------------------------------
  HLDA   |Подтверждение| Высокий | Выход |     S     |     нет
         |захвата шины |         |       |           |
-------------------------------------------------------------------
.
                                     - 87 -
           
           

                                   Продолжение таблицы 5-4
-------------------------------------------------------------------
  PEREQ  |Запрос сопро-| Высокий | Вход  |     A     |     нет
         |цессора      |         |       |           |
-------------------------------------------------------------------
  BUSY#  |Сопроцессор  | Низкий  | Вход  |     A     |     нет
         |занят        |         |       |           |
-------------------------------------------------------------------
 ERROR#  |Ошибка сопро-| Низкий  | Вход  |     A     |     нет
         |цессора      |         |       |           |
-------------------------------------------------------------------
   INTR  |Маскируемый  | Высокий | Вход  |     A     |     нет
         |запрос пре-  |         |       |           |
         |рывания      |         |       |           |
-------------------------------------------------------------------
   NMI   |Немаскируемый| Высокий | Вход  |     A     |     нет
         |запрос преры-|         |       |           |
         |вания        |         |       |           |
-------------------------------------------------------------------
  RESET  |Сброс        | Высокий | Вход  | A(примеча-|     нет
         |             |         |       |    ние)   |
-------------------------------------------------------------------
     Примечание:  Если  фаза  внутреннего  синхросигнала процессора
должна быть синхронизирована  с  внешними  схемами,  то  необходимо
обеспечить  определенные  значения  времени установки t25 и времени
удержания t26 отрицательного фронта сигнала RESET.
     
     
                  5.3  Механизм обмена по шине
     
                         5.3.1  Введение

     Все передачи данных  занимают  один  или  более  циклов  шины.
Операнды  логических  данных  длиной  в байт, слово и двойное слово
могут быть переданы без выравнивания физических адресов. Любой байт
может  быть  краевым  байтом  (первым  или последним) передаваемого
операнда, но при этом для передачи  невыровненного  операнда  может
потребоваться  два  или  даже  три физических цикла шины. (См.5.3.4
Изменяемый размер шины данных и 5.3.6 Невыровненные операнды.)
     Сигналы  адреса  80386  предусмотрены для упрощения аппаратуры 
внешней системы. Старшие биты адреса  реализованы  линиями  A2-A31. 
Младшие   биты   адреса   в  виде  BE0#-BE3#  обеспечивают  выборку 
соответственно четырех  байтов  32-битной  шины  данных.  Благодаря 
этому  физический  операнд представляется в каждом цикле в наиболее 
удобной форме. 
     Активные уровни выходных  сигналов  стробов  данных  BE0#-BE3# 
устанавливаются,  если  соответствующие  им байты шины данных будут 
принимать участие в предстоящем цикле шины, как указано в табл.5-5. 
Изменяя  комбинацию  установленных стробов данных можно осуществить 
любой  вариант  выборки  смежных  байтов,  но  никакая   комбинация 
BE0#-BE3#  не  позволит  выбрать байты, разделенные двумя или тремя 
нефункционирующими байтами.                        
     Адресные биты A0-A1 физического  адреса  операнда  могут  быть 
образованы,  когда необходимо (например, для интерфейсов Multibus I 
и  Multibus  II),  как  функция   установленных   стробов   данных. 
Соответствие  значений  A0  и  A1  сигналам  BE0#-BE3#  приведено в 
табл.5-6. Логические  схемы  формирования  A0  и  A1  приведены  на 
рис.5-3. 
. 
                                     - 89 -
           
           
     Таблица 5-5.   Стробы данных и соответствующие им байты
                               данных и операндов
-------------------------------------------------------------------
 Стробы данных   |     Соответствующие сигналы шины данных
-------------------------------------------------------------------
    BE0#         |   D0-D7 (байт 0 - младший байт)
-------------------------------------------------------------------
    BE1#         |   D8-D15 (байт 1)
-------------------------------------------------------------------
    BE2#         |   D16-D23 (байт 2)
-------------------------------------------------------------------
    BE3#         |   D24-D31 (байт 3 - старший байт)
-------------------------------------------------------------------
     
          Таблица 5-6.  Формирование шины A0-A31 из шины
                               BE0#-BE3# и A2-A31
-------------------------------------------------------------------
                      Адресные сигналы 80386
-------------------------------------------------------------------
     A31 ......... A2      |  BE3#  |  BE2#   |  BE1#   |   BE0#
-------------------------------------------------------------------
     |  Физический адрес   |        |         |         |
---------------------------|        |         |         |
 A31 | .....| A2 | A1 | A0 |        |         |         |
-------------------------------------------------------------------
 A31 | .....| A2 | 0  | 0  |   X    |    X    |    X    | Низкий
-------------------------------------------------------------------
 A31 | .....| A2 | 0  | 1  |   X    |    X    | Низкий  | Высокий
-------------------------------------------------------------------
 A31 | .....| A2 | 1  | 0  |   X    | Низкий  | Высокий | Высокий
-------------------------------------------------------------------
 A31 | .....| A2 | 1  | 1  | Низкий | высокий | Высокий | Высокий
-------------------------------------------------------------------
     
     Рис.5-3   Логические схемы формирования A0, A1 как функций
                             сигналов BE0#-BE3#

     K - MAP for A1 Signal - карта Карно для сигнала A1.
     
     
     Каждый цикл шины включает в себя по меньшей мере два состояния
шины.  Каждое  состояние  шины  занимает  по  времени  один  период
тактовой  частоты  процессора.  Простейший  цикл  шины  может  быть
дополнен состояниями шины, которые называются состояниями ожидания.
См. 5.4  Описание функционирования шины.
     Поскольку  для выполнение цикла шины требуется как минимум два
состояния  шины  (что  равняется  двум  периодам  тактовой  частоты
процессора),   то   максимальная  скорость  передачи  данных  между
внешними  устройствами  и  80386  равна одному 4-байтовому двойному 
слову  в  каждые  два  периода  тактовой  частоты  процессора,  что
соответствует   максимальной   пропускной   способности   шины   32
мегабайт/сек (80386-16 работает на тактовой частоте 16 МГц).
.
                                     - 90 -
           
           
               5.3.2  Пространства памяти и ввода/вывода

     В течение циклов шины возможно обращение к пространству памяти
или к пространству ввода/вывода. Периферийные устройства в  системе
могут быть отнесены либо к пространству памяти, либо к пространству
ввода/вывода, или и к тому и к другому пространствам. Как  показано
на  рис.5-4,  физические   адреса   памяти находятся в диапазоне от
00000000H до FFFFFFFFH (4 гигабайта), а  адреса  ввода/вывода  -  в
диапазоне от 00000000H до 0000FFFFH (64 килобайта), необходимом для
адресации  устройств  ввода/вывода.  Отметим  адреса  ввода/вывода,
используемые   в   автоматически   выполняемых  для  взаимосвязи  с
сопроцессором циклах  ввода/вывода.  Эти  адреса  от  800000F8H  до
800000FFH   не   входят   в   диапазон  вышеуказанных  адресов  для
программной адресации  устройств  ввода/вывода  и  позволяют  легко
сформировать  сигнал  выборки сопроцессора, используя сигналы A31 и
M/IO#.
     
  FFFFFFFFH -------------            - - - - - - -
            |           |            |           |
            |           |           
            |           |            | неадресуе-|
            |           |                мое
            |           |            |           |
            |           |
            |           |            |           |
            |           |  800000FFH |-----------|  Сопроцессор
            | Физичес-  |  800000F8H |           |  (80387 или
            |  кая      | (Примеч.1) |-----------|    80287)
            |  память   |            |           |
            |           |              Неадресуе-
            | 4 гига-   |            |   мое     |
            |   байта   |
            |           |  0000FFFFH |-----------| Программно-
            |           |            | 64 Кбайта | -адресуемое 
            |           |            |           | пространство
  00000000H -------------  00000000H ------------- ввода-вывода

             Пространство             Пространство
             физической               ввода/вывода
             памяти
     
     Примечание:  Так  как  в  течение  автоматически   выполняемых
циклов  взаимосвязи с сопроцессором устанавливается высокий уровень
сигнала A31, то установка единичного уровня A31 и  нулевого  уровня
строба формирования сигала выборки сопроцессора.
     
       Рис.5-4  Пространства физической памяти и ввода/вывода
.
                                     - 91 -
           
           
     
             5.3.3  Организация памяти и ввода/вывода

     Ширина  магистрали  данных  от  80386 к пространствам памяти и
ввода/вывода  может  составлять  32  бита  или  16  бит.  В  случае
32-разрядной  ширины  магистрали пространства памяти и ввода/вывода
организованы соответственно  как  массивы  физических  32-разрядных
двойных  слов. Каждое двойное слово памяти или ввода/вывода состоит
из 4-х индивидуально адресуемых (с помощью последовательных адресов
байтов)  байтов. Самый меньший (из четырех) адрес байта относится к
сигналам D0-D7; самый больший - к сигналам D24-D31.
     80386 имеет такой сигнал управления шиной, как BS16#,  который
обеспечивает  правильную взаимосвязь с 16-разрядными пространствами
памяти и ввода/вывода, организованными  в  виде  последовательности
16-битных  слов.  Циклы  обмена  с  16-разрядными  и  32-разрядными
устройствами памяти или  ввода/вывода  могут  встречаться  в  любой
последовательности, так как состояние сигнала BS16# анализируется в
течение каждого  цикла  шины.  См.  5.3.4  Изменяемый  размер  шины
данных.  Сигналы  стробов  данных  BE0#-BE3# позволяют обращаться к
отдельным  байтам  при  любой  структуре  памяти  или  ввода/вывода
(32-разрядной или 16-разрядной).
     
     
               5.3.4  Изменяемый размер шины данных

     Изменяемый  размер  шины  данных  -  отличительная особенность
80386,  обеспечиваютщая   непосредственную   связь   процессора   с
32-разрядными   или   16-разрядными   шинами   данных   памяти  или
ввода/вывода. Один процессор может  быть  соединен  с  шинами  двух
размеров.  Передачи  в/из 32- или 16-разрядные порты сопровождаются
определением в каждом цикле шины необходимой ширины шины. В течение
каждого   цикла   шины  схема  дешифрации  адреса  или  подчиненное
устройство сами могут установить активный уровень сигнала BS16# для
16-разрядного порта, или неактивный уровень BS16# для 32-разрядного
порта.
     Когда  установлен  активный  уровень  сигнала BS16#, процессор 
автоматически вместо одной передачи разрядностью больше 16 бит  или 
одной  16-разрядной  невыровненной  передачи  выполнит  две или три 
передачи, как потребуется. При активном уровне BS16#  все  передачи 
операндов   осуществляются   только   по   линиям  D0-D15.  Поэтому 
16-разрядные устройства памяти или ввода/вывода обмениваются только 
сигналами  данных  D0-D15. Специальных переключателей не требуется. 
Действие активного уровня сигнала BS16# проявляется  только  тогда, 
когда  в  текущем  цикле  шины установлены активные уровни сигналов 
BE2# и/или BE3#. Если в передаче участвуют только линии D0-D15,  то 
установка  активного  уровня BS16# не будет иметь значение, так как 
передача  будет  производиться  все  равно  по  16-разрядной   шине 
независимо от состояния BS16#. Другими словами, установка активного 
уровня BS16# необязательна, когда только младшая половина  разрядов 
шины участвует в текущем цикле. 
     Существуют  две  ситуации,  при  которых  проявляется  влияние
активного  уровня  BS16#  на действия процессора, зависящие таже от
значений стробов данных BE0#-BE3# в текущем цикле шины:
     - в обмене  участвует  только  старшая  половина  линий  шины:
устанавливаются активные уровни только сигналов BE2# и/или BE3#;
     - в обмене участвуют и старшая, и младшая половины линий шины:
устанавливаются активные уровни по меньшей  мере  сигналов  BE1#  и
BE2# (и возможно также сигналов BE0# и/или BE3#).
     Воздействие  BS16#  на  циклы  чтения "с учетом только старшей
половины линий шины":

                                     - 92 -
           
           
     Установка активного уровня BS16# в течение  циклов  чтения  "с
участием   только   старшей  половины  линий  шины"  вынудит  80386
считывать младшие 16 битов шины данных  и  игнорировать  данные  на
старших 16 битах шины данных. Т.е. вместо считывания данных с линий
D16-D31  в  соответствии  с  установленными  BE2#  и   BE3#   будут
считываться данные с линий D0-D15.
     Взаимодействие  сигнала  BS16#  на  циклы  записи  "с участием
только старшей половины линий шины":
     Установка активного уровня BS16# в течение  циклов  записи  "с
участием только старшей половины" не отразится на процедуре записи.
Когда в цикле записи  установлены  активные  уровни  сигналов  BE2#
и/или  BE3#,  80386 всегда копирует сигналы данных D16-D31 на линии
D0-D15  (см.  табл.  5-1).  Поэтому  не  требуется   дополнительных
действий  80386  для  того, чтобы выполнить эти циклы записи по 32-
или 16-разрядной шине.
     Воздействие сигнала  BS16#  на  циклы  чтения  "с  участием  и
старшей и младшей половин шины":
     Установка  активного  уровня  сигнала  BS16#  в течение циклов
чтения "с участием и  старшей  и  младшей  половин  шины"  заставит
процессор  выполнить  два  16-разрядных  цикла  чтения для передачи
всего  физического  операнда.  Байты  0  и  1  (в  соответствии   с
установленными  BE0#  и  BE1#) будут считаны в первом цикле с линий
D0-D15.  Байты  2 и 3 (в соответствии с установленными BE2# и BE3#)
будут  считаны  во  втором цикле и снова с линий D0-D15. Сигналы на
линиях D16-D31 игнорируются в течение  обоих  16-разрядных  циклов.
BE0#  и  BE1#  всегда  находятся  в  неактивном состоянии в течение
второго 16-разрядного цикла.
     Активный уровень сигнала BS16# необязательно устанавливать  на
время второго 16-разрядного цикла. См. рис.5-14, циклы 2 и 2а.
     Воздействие  сигнала  BS16# (активного уровня) на циклы записи
"с участием и старшей и младшей половин шины":
     Установка активного уровня  сигнала  BS16#  в  течение  циклов
записи  "с  участием  и  старшей  и  младшей половин шины" заставит
процесор 80386 выполнять два 16-разрядных цикла записи для передачи
целого физического операнда. Наличие всех байтов операнда на линиях
D0-D15 в течение первого цикла записи позволит внешним  устройствам
получить  байты  0  и 1 (в соответствии с установленными значениями
BE0# и BE1#) по линиям D0-D15.  Во  втором  цикле  80386  скопирует
байты 2 и 3 на линии D0-D15, и запись этих байтов (в соответствии с
установленными значениями BE2# и BE3#) будет произведена  также  по
линиям   D0-D15.   Сигналы  BE0#  и  BE1#  всегда  переключаются  в
неактивное  состояние  в  течение  второго   16-разрядного   цикла.
Установка   активного   уровня  сигнала  BS16#  в  течение  второго
16-разрядного цикла необязательна. См. рис.5-14, циклы 1 и 1а. 
     
     
        5.3.5  Связь с 32- и 16-разрядным устройствами памяти

     В  32-разрядных  устройствах  физической  памяти, таких как на
рис.5-5,  каждое физическое двойное слово начинается с байта, адрес
которого  кратен  4. Сигналы A2-A31 обычно используются для выборки
определенного двойного слова, а сигналы  BE0#-BE3#  -  для  выборки
определенного   байта  в  двойном  слове.  BS16#  поддерживается  в
неактивном  состоянии  во   всех   циклах   шины,   оперирующих   с
32-разрядным массивом.
     Когда в состав системы входят 16-разрядные физические массивы,
как  показано  на  рис.5-6,  адрес   начала    каждого   16-битного
физического  слова  кратен  2. Отметим, что схема дешифрации адреса
ADDRESS DECODER при дешифрации адреса  формирует  активный  уровень
сигнала   BS16#   только  в  течение  циклов  шины,  оперирующих  с

                                     - 94 -
           
           
16-разрядными  устройствами  памяти,  то  схема  дешифрации  адреса
анализирует   также  значения  сигналов  BE0#-BE3#  и  W/R#,  чтобы
определить, когда должен быть установлен активный  уровень  сигнала
BS16#.  См.  5.4.3.7  Оптимальное  использование метода конвейерной
адресации в случае 16-разрядной ширины шины.
     Сигналы A2-A31 обычно используются для адресации  32-разрядных
и  16-разрязных  устройств.  Для  адресации  16-разрядных устройств
необходимы также сигнал A1 и два сигнала строба данных.
     Чтобы сформировать необходимые  значения  сигнала  A1  и  двух
сигналов  стоба  данных  для  обращения к 16-разрядному устройству,
сигналы BE0#-BE3# должен быть дешифрированы в соответствии с  табл.
5-7. Отметим некоторые запрещенные комбинации BE0#-BE3#, никогда не
вырабатываемые 80386. При наличии запрещенной комбинации  BE0#-BE3#
на  входе  дешифратора  выходы  его не анализируются и состояние их
обозначается  X.  Запрещенные  комбинации  BE0#-BE3#   могут   быть
использованы при необходимости для более оптимального использования
дешифратора.
.
                                     - 95 -
           
           
     Таблица 5-7.  Формирование сигналов A1, BHE# и BLE# для
                        адресации 16-разрядных устройств
-------------------------------------------------------------------
     Сигналы 80386         |  Сигналы 16-разрядной | Комментарии
                           |         шины          |
---------------------------|-----------------------|
 BE3# | BE2# | BE1# | BE0# | A1 | BHE# | BLE# (A0) |   
-------------------------------------------------------------------
  H*  |  H*  |  H*  |  H*  | X  |  X   |     X     | X - нет ни 
      |      |      |      |    |      |           | одного актив-
      |      |      |      |    |      |           | ного байта
-------------------------------------------------------------------
  H   |  H   |  H   |  L   | L  |  H   |     L     |
-------------------------------------------------------------------
  H   |  H   |  L   |  H   | L  |  L   |     H     |
-------------------------------------------------------------------
  H   |  H   |  L   |  L   | L  |  L   |     L     |
-------------------------------------------------------------------
  H   |  L   |  H   |  H   | H  |  H   |     L     |
-------------------------------------------------------------------
  H*  |  L*  |  H*  |  L*  | X  |  X   |     X     | X - несмежные
      |      |      |      |    |      |           |      байты
-------------------------------------------------------------------
  H   |  L   |  L   |  H   | L  |  L   |     H     |
-------------------------------------------------------------------
  H   |  L   |  L   |  L   | L  |  L   |     L     |
-------------------------------------------------------------------
  L   |  H   |  H   |  H   | H  |  L   |     H     |
-------------------------------------------------------------------
  L*  |  H*  |  H*  |  L*  | X  |  X   |     X     | X - несмежные
      |      |      |      |    |      |           |      байты
-------------------------------------------------------------------
  L*  |  H*  |  L*  |  H*  | X  |  X   |     X     | X - несмежные
      |      |      |      |    |      |           |      байты
-------------------------------------------------------------------
  L   |  L   |  H   |  H   | H  |  L   |     L     |
-------------------------------------------------------------------
  L*  |  L*  |  H*  |  L*  | X  |  X   |     X     | X - несмежные
      |      |      |      |    |      |           |      байты
-------------------------------------------------------------------
  L   |  L   |  L   |  H   | L  |  L   |     H     |
-------------------------------------------------------------------
  L   |  L   |  L   |  L   | L  |  L   |     L     |
-------------------------------------------------------------------
     BLE#  устанавливается  (активный уровень) когда активизируются
           разряды D0-D7 16-разрядной шины.
     BHE# устанавливается (активный уровень)  когда  активизируются
          разряды D8-D15 16-разрядной шины.
     A1 имеет низкий уровень для всех четных слов; A1 имеет высокий
уровень для всех нечетных слов. 
     
     Обозначения:  X  -  допустим  и  высокий  и  низкий логический
                         уровень; 
                   H - высокий логический уровень;
                   L - низкий логический уровень;
                   * - неиспользуемые комбинации BE0#-BE3#:
     - комбинация, когда все стробы данных находятся  в  неактивном
       состоянии;
     -  комбинации стробов данных, при которых появляются несмежные
        активные байты.

                                     - 97 -
           
     
     
                    5.3.6  Выравнивание операндов

     Благодаря гибкой адресации памяти в  80386  возможна  передача
логического   операнда,   разрядность  которого  больше  слова  или
двойного слова  памяти  или  ввода/вывода,  например  32-разрядного
операнда  (двойное  слово),  адрес  начала которого некратен 4, или
16-разрядного   операнда   (слово),   разделенного   между    двумя
физическими двойными словами массива памяти.
     Когда  передача операнда требует выполнения нескольких циклов,
то  во  время  этих  циклов  выполняется  выравнивание   данных   и
определение  размера  шины. Таблица 5-8 описывает определение типов
циклов передачи для всех комбинаций таких характеристик, как  длина
логического  операнда, выравнивание и ширина шины данных. Когда для
передачи многобайтового логического  операнда  требуется  несколько
циклов   шины,   то  первыми  передаются  старшие  байты  (но  если
установлен  активный  уровень  BS16#,  то   будут   выполнены   два
16-разрядных цикла, причем первыми будут переданы младшие байты).
     
     Таблица 5-8.  Циклы передачи байтов, слов и двойных слов
-------------------------------------------------------------------
                |       Длина логического операнда в байтах
                |--------------------------------------------------
                |  1   |           2         |          4
-----------------------|---------------------|---------------------
 Адрес байта фи-| XX   | 00  | 01 | 10 | 11  | 00  | 01 | 10 | 11
 зической памяти|      |     |    |    |     |     |    |    |
 (младшие два   |      |     |    |    |     |     |    |    |
 байта)         |      |     |    |    |     |     |    |    |
-------------------------------------------------------------------
 Циклы передачи |  b   |  W  | W  | W  | hb, |  d  | hb,| hw,| h3,
 по 32-разрядной|      |     |    |    | lb  |     | l3 | lw | lb
 шине данных    |      |     |    |    |     |     |    |    |
-------------------------------------------------------------------
 Циклы передачи |  b   |  W  |lb,*| W  | hb,*| lw,*| hb,| hw,| mw,*
 по 16-разрядной|      |     |hb* |    | lb* | hw* |lb,*| lw | hb,*
 шине данных    |      |     |    |    |     |     | mw*|    | lb
-------------------------------------------------------------------
                
     Обозначения:  b = передача байта
                   w = передача слова
                   l = младшая часть операнда
                   m = средняя часть операнда
                   х = не используется
                   * = активный уровень BS16# вызывает выполнение
                       второго цикла шины
                   3 = передача 3-х байтов
                   d = передача двойного слова
                   h = старшая часть операнда
     
     
                5.4  Описание функционирования шины

                            5.4.1 Введение

     80386  имеет  отдельные  параллельные шины: шину адреса и шину
данных. Шина данных - 32-разрядная и двунаправленная.  Ширина  шины
адреса  - 32 разряда: из них 30 старших разрядов - адрес операнда и
2 разряда формируются из 4-х  сигналов  стробов  данных  каждый  из

                                     - 98 -


которых  служит  для выборки соответствующего байта в операнде. Эти
шины анализируются и управляются соответствующими  им  управляющими
сигналами.
     Тип  каждого  цикла  шины определяется тремя сигналами: M/IO#,
W/R#  и  D/C#.  Одновременно  с  этими  сигналами   устанавливается
достоверный  адрес  на  линиях  BE0#-BE3#  и  A2-A31. Сигнал строба
адреса указывает на выдачу процессором 80386 нового типа цикла шины 
и адреса.
     Объединенные шина адреса, шина данных и все связанные  с  ними
управляющие сигналы называются в тексте просто "шиной".
     В  рабочем  состоянии шина выполняет один из нижеперечисленных
циклов шины:
     1) чтение из памяти;
     2) чтение из памяти с блокировкой шины;
     3) запись в память;
     4) запись в память с блокировкой шины;
     5) чтение из устройства ввода/вывода (или из сопроцессора);
     6) запись в устройство ввода/вывода (или в сопроцессор);
     7) подтверждение прерывания;
     8) цикл останова или цикл выключения.
     Табл.   5-2   показывает   соответствие   комбинаций  сигналов
определения типа шины каждому типу шины. См. параграф 5.2.5 Сигналы
определения типа цикла шины.
     Отличительной   чертой  шины  данных  является  ее  изменяемая
ширина, которая может быть 32-разрядной и 16-разрядной. Ширина шины
данных указывается процессору 80386 его входным сигналом BS16#. Все
функции шины могут быть выполнены при любой ширине шины.
     Когда шина 80386 не выполняет  ни  один  из  вышеперечисленных
циклов,  она  находится  или  в нерабочем состоянии или в состояние
подтверждения захвата шины, последнее может  быть  вызвано  внешней
схемой.
     Нерабочее  состояние  шины  может  иметь место, когда 80386 не
выдает дальнейших подтверждений на свой выход строба адреса  (ADS#)
после начала текущего цикла, и потому текущий цикл будет последним.
Состояние подтверждения захвата  шины  идентифицируется  установкой
процессором  80386  активного  уровня на своем выходе подтверждения
захвата (HLDA). 
     Самой короткой временной единицей деятельности  шины  является
состояние шины. Деятельность состояния шины составляет один  период
тактовой частоты процессора (два периода CLK2).
     Законченная  передача  данных  осуществляется  в течение цикла
шины, состоящего из двух или более состояний шины.
     Самый короткий цикл шины 80386 состоит из двух состояний шины.
Состояния  шины  в  каждом  цикле обозначены как Т1 и Т2. В течение
такого цикла шины (из 2-х состояний) может быть выполнено обращение
по  любому  адресу памяти или ввода/вывода, если внешняя аппаратура
обладает   достаточным    быстродействием.    Высокая    пропускная
способность  шины  и  цикл  шины,  занимающий  два периода тактовой
частоты, наиболее  полно  реализуют  возможности  быстрой  основной
памяти или кэш-памяти.
     Каждый   цикл   шины   длится  до  тех  пор,  пока  не  придет
подтверждение от внешних устройств системы, использующих  для  этой
цели  вход  80386  READY#.  Если  подтверждение  цикла  шины  будет
сформировано в конце первого из  состояний  Т2,  то  это  определит
выполнение  самого  короткого  цикла шины, состоящего всего из двух
состояний Т1 и Т2. Однако, если активный уровень сигнала READY#  не
будет  установлен сразу (в конце первого Т2), то состояния Т2 будут
неограничено повторятся до тех пор, пока на входе READY#  процессор
не обнаружит активный уровень.

                                     - 100 -
           
     
                    5.4.2  Конвейерная адресация
     
     Режим    конвейерной   адресации   обеспечивает   определенные
протоколы цикла шины.
     Протокол конвейерной или неконвейерной адресации выбирается на
основе  совмещения  циклов с использованием входа следующего адреса
(NA#).
     В режиме неконвейерной адресации текущий  адрес  и  тип  цикла
шины остаются постоянными в течение всего цикла шины.
     В режиме конвейерной адресации адрес (BE0#-BE3#, A2-A31) и тип
цикла для  следующего  цикла  устанавливаются  и  выдаются  еще  до
окончания  текущего  цикла. Чтобы сигнализировать об их готовности,
80386 устанавливает также активный уровень на выходе строба  адреса
(ADS#).  Рис.5-9  иллюстрирует  самые быстрые циклы чтения в режиме
конвейерной адресации. Из рис.5-9   следует,   что  самые  короткие
циклы шины, использующие метод конвейерной адресации, состоят всего
из  двух  состояний  шины,  обозначенных  Т1Р и Т2Р. Следовательно,
циклы с конвейерной адресацией  обеспечивают  такую  же  пропускную
способность  данных,  как  и  циклы  с неконвейерной адресацией, но
время выборки адреса увеличивается по  сравнению  с  неконвейерными
циклами.
     Из-за  увеличения  времени  выборки  адреса  режим конвейерной
адресации  сокращает  требуемое  количество   состояний   ожидания.
Например,  если  в  режиме  конвейерной  адресации  требуется  одно
состояние ожидания, то в  режиме  конвейерной  адресации  может  не
потребоваться ни одного состояния ожидания.
     Режим  конвейерной адресации используеется в системах, имеющих
адресные "защелки". В таких системах, сразу "защелкивающих"  адрес,
конвейерная  выдача  следующего адреса позволяет декодирующей схеме
заранее  сформировать  сигналы  включения   микросхем   (и   другие
необходимые   сигналы   выборки),  поэтому  обращение  к  выбранным
устройствам осуществляется сразу, как только  начинается  следующий
цикл.  Другими  словами,  время  декодирования для следующего цикла
может частично перекрываться с окончанием текущего цикла.
     Если в состав системы входит память с расслоением,  имеющая  2
или более банков, то метод конвейерной адресации возможно обеспечит
даже большее перекрытие циклов. Вышесказанное действительно,  когда
контроллер памяти с расслоением устроен так, чтобы позволить начать
следующую операцию с памятью в одном банке памяти в то  время,  как
текущий  цикл  шины еще оперирует с другим банком памяти.  Рис.5-10
показывает основную структуру  взаимосвязи  80386  с  2-банковой  и
4-банковой памятью с расслоением. Отметим, что каждый банк памяти с
расслоением имеет шину данных  полной  ширины  (обычно  разрядность
данных  составляет  32  бита,  если не задается 16-разрядная ширина
шины).
     Дополнительные сведения о режиме крнвейерной адресации даны  в
параграфах  5.4.3.4  Конвейерная адресация, 5.4.3.5 Инициализация и
поддержание режима конвейерной адресации, 5.4.3.6 Конвейерный адрес
при изменении  ширины  шины  и  5.4.3.7  Оптимальное  использование
конвейерного адреса в случае 16-разрядной ширины шины.
     
     
                  5.4.3  Циклы чтения и записи
     
                        5.4.3.1 Введение
     
     Передачи данных осуществляется посредством  выполнения  циклов
шины,  которые  подразделяются  на циклы чтения и циклы записи. При
выполнении циклов чтения данные передаются от внешнего устройства в

                                     - 102 -
           
           
процессор.   При  выполнении  циклов  записи  данные  передаются  в
обратном направлении: от процессора к внешнему устройству.
     Два варианта адресации попеременно  избираются:  неконвейерная
адресация   или   конвейерная.   После  нерабочего  состояния  шины
процессор всегда работает в режиме неконвейерной адресации. Однако,
может   быть  установлен  активный  уровень  входного  сигнала  NA#
(следующий  адрес),  избирающий  режим  конвейерной  адресации  для
следующего  цикла шины. Когда выбран режим конвейерной адресации, и
в процессоре  имеется  ожидающий  обслуживвания  внутренний  запрос
шины, достоверные адрес и тип цикла для следующего цикла шины будут
выданы даже до получения подтверждения текущего цикла шины на входе
READY#. В каждом цикле шины 80386 обязательно анализирует состояние
сигнала  на  входе  NA#,   чтобы   определить   способ   адресации,
необходимый для следующего цикла.
     Попеременно  избираются  два  варианта размера физической шины
данных: 32 бита или 16 битов. Обязательно ближе к концу цикла  шины
состояние  входного  сигнала BS16# (размер шины 16) анализируется с
целью установления размера физической шины данных,  необходимого  в
текущем   цикле.   Высокий   уровень  сигнала  BS16#  указывает  на
32-разрядный размер, активный уровень (низкий) BS16#  указывает  на
16-разрядный размер. Если указан 16-разрядный размер шины, то 80386
автоматически  реагирует  на  это  соответствующим  образом,  чтобы
завершить  передачу  по  16-разрядной шине данных. В зависимости от
размера  и  расположения  операнда   может   потребоваться   второй
16-разрядный  цикл  шины.  Подробно  об  этом  см. табл. 5-7. Когда
необходимо, 80386 выполняет дополнительный 16-разрядный цикл  шины,
используя линии D0-D15 для передачи разрядов D16-D31.
     Для  завершения  цикла  чтения  или  цикла записи, также как и
любого  другого  цикла   шины,   требуется   подтверждение   цикла,
устанавливаемое   на   входе  READY#.  До  получения  подтверждения
процессор  вводит   в   цикл   шины   состояние   ожидания,   чтобы
соответствовать   быстродействию   внешнего   устройства.   Внешнее
устройство, распознавшее свой  адрес  и  декодировавшее  тип  цикла
шины,  формирует  в соответствующий момент активный уровень сигнала
READY#.
     Сигнал READY# анализируется во втором  состоянии  цикла  шины.
Если  в  это  же  время  внешняя  аппаратура подтверждает цикл шины
установкой активного уровня READY#, то цикл шины  завершается,  как
показано на рис.5-11.
     Если  во  втором  состоянии  шины  сигнал  READY#  остается  в
неактивном  состоянии,  как  показано   на   рис.5-12,  цикл   шины
дополняется  еще  одним  состоянием (состоянием ожидания), и сигнал
READY# будет снова анализироваться в конце каждого такого состояния
ожидания.  Так  будет  продолжиться  неограниченно до тех пор, пока
цикл не получит подтверждения по линии READY#.
     Когда процессор  получает  подтверждение  текущего  цикла,  он
завершает    его.   Когда   подтверждается   цикл   чтения,   80386
"защелкивает" информацию, сформированную к этому времени на выводах
шины  данных  процессора.  Когда  подтверждается цикл записи, 80386
поддерживает достоверное значение  записываемых  данных  в  течение
первой  фазы  следующего  цикла  шины, чтобы обеспечить необходимое
значение времени удержания записываемых данных.
     
     
                5.4.3.2  Неконвейерная адресация
     
     Любой  цикл  шины  может  быть выполнен в режиме неконвейерной 
адресации. Для примера,  на  рис.5-11  показана  последовательность 
циклов  чтения  и  записи  в  режиме  неконвейерной  адресации.  Из 
рис.5-11  следует,  что  самые  короткие  циклы, возможные в режиме 
 
                                     - 106 -
           
           
неконвейерной адресации, состоят каждый  из  двух  состояний  шины.
Состояния  обозначены  как  Т1  и  Т2.  В  первой фазе состояния Т1
выдаются  достоверные   значения   сигналов   адреса   и   сигналов
определения   типа   цикла  шины,  и  одновременно  устанавливается
активный уровень сигнала строба адреса  (ADS#),  сигнализирующий  о
готовности вышеперечисленных сигналов.
     В  течение  циклов чтения или записи шина данных фкнкционирует
как описано ниже. В цикле чтения 80386 переключает свою шину данных
таким  образом,  чтобы  принять  сигналы  данных  от  адресованного
внешнего устройства.  В  цикле  записи  сигналы  данных  передаются
процессором  80386,  начиная со второй  фазы  состояния Т1 и кончая
первой фазой состояния шины, которое будет установлено сразу  после
получения подтверждения цикла.
     Рис.5-12   иллюстрирует   циклы  шины  в  режиме неконвейерной
адресации, причем циклы 2 и 3 дополнены одним состоянием  ожидания.
В  циклах  2  и 3 сигнал READY# оказался неустановленным в активное
состояние  Т2.  В  этих  циклах  активный  уровень  сигнала  READY#
устанавливается в конце второго из состояний Т2. 
     Когда   не  используется  конвейерная  адресация,  достоверные
значения адреса и  типа  цикла  шины  сохраняются  в  течение  всех
состояний  ожидания. Когда цикл дополняется состояниями ожидания, и
необходимо обеспечить  режим  неконвейерной  адресации,  неактивный
(высокий)  уровень  сигнала  NA# должен устанавливаться  в  течение
каждого из состояний Т2,  исключая  самое  последнее  состояние  Т2
цикла, как показано  на  рис.5-12  в  циклах  2 и 3.  Если активный
уровень  NA#  окажется  установленным  в  состояние  Т2  (но  не  в
последнем  Т2),  то  следующим состоянием, вместо состояния Т2 (для
неконвейерной адресации),  будет  состояние  Т2i  (для  конвейерной
адресации) или Т2p (для конвейерной адресации).
     Рис.5-13  наиболее полно иллюстрирует картину состояний шины и
переходов из состояния в состояние для  случая,  когда  конвейерная
адресация  не  используется.  Показанные  переходы  шины между 4-мя
возможными состояниями: Т1,  Т2,  Тi  и  Тh.  Циклы  шины  содержат
состояния   Т1   и  Т2,  причем  Т2  может  повторяться  (состояния
ожидания).  Кроме  этого,  шина  может   находиться   в   нерабочем
состоянии,  т.е.  в  состоянии  Тi,  или  в состоянии подтверждения
захвата шины, т.е. в состоянии Тh. 
     Для  случая,  когда  конвейерная  адресация  не  используется,
диаграмма  состояния  шины  такая,  как  показана  на  рис.5-13.  В
нерабочем   состоянии  шина  находится  в  Тi.  Циклы  шины  всегда
начинаются с Т1. Т1 всегда предшествует  состоянию  Т2.  Если  цикл
шины не подтвержден в течение Т2 и уровень NA# при этом неактивный,
состояние Т2 повторяется. Когда цикл подтвержден в течение  Т2,  то
за  этим последует состояние Т1 следующего цикла шины, если имеется
ожидающий обслуживания внутренний запрос  шины  (запрос  на  захват
шины самим процессором), или состояние Тi, если такого запроса нет,
или состояние Тh, если установлен активный уровень входного сигнала
HOLD.
     Диаграмма  состояния  шины  на рис.5-13  справедлива при любом
значении   сигнала   BS16#.   Если   80386   выполнит    внутренние
переключения, необходимые для установки 16-разрядного размера шины,
то эти переключения не повлияют на состояния внешней шины. Если для
выполнения  передачи  по 16-разрядной шине требуется дополнительный
16-разрядный цикл шины, он также будет выполняться в соответствии с
переходами состояний, показанными на рис.5-13.
     В режиме конвейерной адресации в 80386  могут  иметь  еще  три 
типа  состояния  шины,  не  показанные  на  рис.5-13. На рис.5-20 в 
параграфе 5.4.3.4 "Конвейерная адресация" показана более  подробная 
диаграмма  состояния  шины,  включающая  циклы в режиме конвейерной 
адресации. 
 
                                     - 108 -
           
           
     Состояния шины:
     Т1  - первое состояние неконвейерного цикла шины (80386 выдает
     новый адрес и устанавливает активный уровень ADS#);
     Т2 - последующие состояния цикла  шины,  когда  при  просмотре
     сигнала  NA#  в текущем цикле шины он оказывается в неактивном
     состоянии; 
     Тi - нерабочее состояние;
     Тh - состояние подтверждения захвата шины (80386 устанавливает
     активный уровень HLDA).
     Самый короткий цикл шины состоит из двух состояний: Т1 и Т2.
     Четыре  основные  состояния  шины  описывают  функционирование
шины, когда не используется конвейерная  адресация.  Эти  состояния
распространяются  на  оба  размера  шины:  32  бит  и  16 бит, т.е.
справедливы для любого значения BS16#.  Если  при  активном  уровне
сигнала  BS16#  требуется  выполнение  второго 16-разрядного цикла,
последний  выполняется  перед  формированием  процессором   сигнала
подтверждения захвата шины.
     
     
        5.4.3.3  Режим неконвейерной адресации при изменении 
                          размера шины данных 
     
     Ширина физической магистрали данных для любого  неконвейерного
цикла  шины  может  составлять  или  32 разряда, или 16 разрядов. В
начале цикла шины процессор ведет себя так, как если бы ширина шины
данных   составляла   32   бита.  Когда  цикл  шины  подтверждается
установкой активного уровня сигнала READY# в конце состояния Т2, то
анализируемый  в  этот  момент  уровень  сигнала  BS16#  окажется в
неактивном состоянии, то размер физической шины данных  принимается
равным  32 разрядам. Если же наблюдается активный уровень BS16#, то
размер шины принимается равным 16 разрядам.
     Когда установлен активный  уровень  BS16#,  и  для  выполнения
одной  передачи  требуется  два  16-разрядных  цикла,  то  активный
уровень сигнала BS16# должен быть установлен  и  во  втором  цикле.
Иначе  16-разрядный  размер шины не будет сохранен во втором цикле.
Также, как и любой  другой  цикл  шины,  второй  16-разрядный  цикл
должен быть подтвержден установкой активного уровня READY#.
     Когда  требуется второй 16-разрядный цикл для выполнения одной
передачи по 16-разрядной шине,  то  адреса,  формируемые  для  двух
16-разрядных циклов шины, тесно взаимосвязаны. Эти адреса идентичны
за исключением разрядов BE0# и BE1#, которые всегда переключаются в
неактивное  состояние  (высокий  уровень)  во втором цикле, так как
сигналы данных D0-D15 были уже переданы в первом 16-битном цикле. 
     На рис.5-14 и 5-15 показаны передачи,  при  которых  установка 
активного   уровня  BS16#  требует  второго  16-битного  цикла  для 
выполнения передачи всего операнда. Рис.5-14 иллюстрирует циклы без 
состояний  ожидания. Рис.5-15 иллюстрирует циклы с одним состоянием 
ожидания. Отметим, что в цикле 1 на рис.5-15,  в  течение  которого 
устанавливается  активный  уровень сигнала BS16#, сигнал NA# должен 
быть обязательно переключен в неактивный  уровень  в  состоянии(ях) 
Т2,  предшествующем(их) последнему состоянию Т2. Это необходимо для 
того,  чтобы  в  финальном   состоянии   Т2   процессор   воспринял 
установленный   активный   уровень  BS16#  в  режиме  неконвейерной 
адресации. 
     
     
                  5.4.3.4  Конвейерная адресация
     
     В   режиме   конвейерной  адресации  адрес  и  тип  цикла  для
следующего цикла шины, который будет обслуживать ждущий  обработки,

                                     - 111 -
           
           
внутреннии  запрос процессора, запрашиваются еще до того, как будет
получено  подтверждение  текущего  цикла  по  линии  READY#.  Когда
следующий  адрес  подготовлен и выдан, 80386 устанавливает активный
уровень  сигнала  ADS#.  Протокол  режима   конвейерной   адресации
строится  на  основе совмещения циклов и с помощью входного сигнала
NA#.
     Когда выполняется цикл  шины  и  текущий  адрес  должен  иметь
достоверное  значение  в  течение  по  меньшей  мере одного полного
состояния шины, значение входного сигнала NA# анализируется в конце
каждой  первой фазы состояния до тех пор, пока цикл шины не получит
подтверждение.  В течение неконвейерных циклов шины, следовательно,
NA# анализируется в  конце  первой  фазы  в  каждом  состоянии  Т2.
Примером  может служить Цикл 2 на рис.5-16, в  течение которого NA#
анализируется в конце первой фазы каждого Т2 (NA# был установлен  в
активный  уровень  один  раз  в  течение  первого состояния Т2 и не
оказывает дальнейшего воздействия на выполнение этого цикла шины).
     Если процессор при просмотре NA#  обнаружит  активный  уровень
этого  сигнала,  то  80386  освобождается, чтобы выдать адрес и тип
цикла следующего цикла, и установить активный уровень сигнала ADS#,
как  только в процессоре появится ожидающий обслуживания внутренний
запрос шины. Процессор может выдать следующий адрес уже в следующем
состоянии  шины,  независимо  от  того  получил  ли  в  этот момент
подтверждение текущий цикл или не получил.
     Что касается режима конвейерной адресации, то  в  этом  режиме
80386 имеет следующие особенности:
     1)  для  того,  чтобы  процессор  воспринял  активный  уровень
сигнала NA#, сигнал  BS16#  должен  быть  переключен  в  неактивный
уровень  на время просмотра сигнала  NA# (см. рис.5-16 Циклы 3 и 4;
рис.5-17 Циклы 2-4);
     В том случае, если сигналы NA# и BS16# окажутся оба  активными
в  течение  последнего  периода  Т2  цикла  шины, приоритетом будет
обладать активный сигнал BS16#.  Следовательно,  если  оба  сигнала
активны,  то  текущий размер шины принимается равным 16 разрядам, а
следующий  адрес   будет    неконвейерным.    Схематично   рис.5-18
показывает внутреннюю логику 80386, обеспечивающую эти особенности.
     2) следующий адрес может появиться в состоянии шины, следующем
сразу после момента обнаружения активного уровня NA#  (см. рис.5-16
или 5-17);
     В  этом  случае  сразу  шина перейдет в состояние Т2p. Однако,
если в этот момент отсутствует  ожидающий  обслуживания  внутренний
запрос  шины,  то  следующий  адрес не будет установлен сразу после
активизации NA#, и вместо состояния Т2p шина перейдет  в  состояние
Т2i  (см. рис.5-19 Цикл 3).  При условии, что текущий цикл шины еще
не получил подтверждение по линии READY#, шина перейдет в состояние
Т2p  как  только  80386 выдает следующий адрес. Внешние устройства,
поэтому, должны  следить  за  состоянием  выходного  сигнала  ADS#,
подтверждающим выдачу на шину достоверного следующего адреса.
     3)  в том случае, когда 80386 при просмотре обнаружит активный 
уровень NA#, 80386 сам принимает  решение  на  обслуживание  самого 
приоритетного  внутреннего  запроса  шины, ожидающего обслуживания. 
Процессор не сможет больше выполнить другую  16-разрядную  передачу 
по  тому  же  адресу,  даже  если BS16# будет установлен в активный 
уровень внешним устройством, так как после  восприятия  процессором 
активного  сигнала  NA# текущий размер шины принимается равным 32-м 
разрядам; 
     Следовательно, если процессор опознал активный  сигнал  NA#  в
течение цикла шины, то после этого сигнал BS16# игнорируется в этом
цикле  шины (см. рис.5-16,  5-17,  5-19).  Таким  образом,  нельзя
активизировать сигнал NA# в тех циклах шины, в которых 16-разрядный
размер шины должен быть задан установкой активного  уровня  сигнала

                                     - 116 -
           
           
BS16#.  См.  5.4.3.6  "Изменение  размера шины в режиме конвейерной
адресации". 
     4)  любой  адрес,  достоверное  значение которого подтверждено
выходным импульсным  сигналом  80386  ADS#,  будет  сохраняться  на
адресных  выводах  в течение по меньшей мере двух периодов тактовой
частоты процессора. 80386 не может выдавать новый адрес  чаще,  чем
каждые  два  периода  тактовой  частоты  процессора  (см. рис.5-16,
5-17, 5-19);
     5) из всех сигналов, необходимых для  следующего  цикла  шины,
процессор выдает только адрес и тип цикла шины; 
     Уровень  совмещения  в  режиме конвейерной адресации не более,
чем один цикл шины (см. рис.5-19 Цикл 1).
     Полная   диаграмма   переходов   состояний    шины,    включая
функционирование в режиме конвейерной адресации, дана  на рис.5-20.
Отметим, что эта диаграмма включает диаграмму, справедливую  только
для  режима неконвейерной адресации, и дополнительные три состояния
шины для режима конвейерной адресации.
     Самый  короткий  цикл  шины  в  режиме  конвейерной  адресации
состоит только из двух состояний шины, Т1p и Т2p (напомним, что для
режима  неконвейерной   адресации   такими   состояниями   являются
состояния   Т1   и   Т2).   Т1p  является  первым  состоянием  шины
конвейерного цикла. 
     
     
       5.4.3.5 Инициализация и поддержание режима конвейерной
                               адресации
     
     Пользуясь диаграммой состояний на рис.5-20, проследим переходы 
шины  из  нерабочего состояния Тi, в начало конвейерного цикла шины 
Т1p. Цикл шины, первый после нерабочего состояния шины  Тi,  должен 
начинаться   с   состояния   Т1,   следовательно  этот  цикл  будет 
неконвейерным. Однако, если будет установлен активный уровень  NA#, 
и  первый  цикл  шины закончится в состоянии Т2p, то следующий цикл 
шины будет конвейерным (адрес для следующего цикла шины выдается  в 
состоянии   Т2p  первого  цикла).  Кратчайший  путь  от  нерабочего 
состояния к циклу шины с конвейерной адресацией показан ниже: 
     
         Тi,Тi,Тi       Т1-Т2-Т2p           Т1p-Т2p
         нерабочее     неконвейерный       конвейерный
         состояние        цикл                цикл
     
     Т1-Т2-Т2p   -   состояние   цикла   шины,   в  течение  корого
устанавливается адрес  (конвейерный)  для  следующего  цикла  шины,
начинающегося  с  состояния  Т1p.  Переход  к конвейерному циклу из
состояния подтверждения захвата шины  осуществляется  аналогично  и
показан ниже:
     
        Тh,Тh,Тh         Т1-Т2-Т2p        Т1p*Т2p
        состояние        неконвейерный    конвейерный
        подтверждения        цикл            цикл
        захвата
     
     Переход  к  ковейерной  адресации показан на рис.5-17  Цикл 1.
Цикл 1 используется для перехода в режим конвейерной адресации  для
выполнения  последовательности  конвейерных  циклов  2,  3  и  4. В
соответствующий момент устанавливается  активный  уровень  NA#  для
того, чтобы выбрать конвейерный адрес для циклов 2, 3 и 4.
     Когда  выполняется  цикл шины, и достоверное значение текущего
адреса удерживается в  течение  одного  состояния  шины,  состояние
входа NA# анализируется в конце каждой первой фазы до тех пор, пока

                                     - 118 -
           
           
этот цикл не получит подтверждение. Следовательно,  в  Цикле  1  на 
рис.5-17 процессор начинает анализ NA# в состоянии Т2. Как только в 
текущем цикле NA# оказывается  установленным  в  активный  уровень, 
80386  освобождается,  чтобы выдать на шину новый адрес и тип цикла 
до  начала  следующего  состояния  шины.  Например,   в   Цикле   1 
обеспечивает  переход  в  режим  конвейерной  адресации, так как он 
начинается  с  состояния  Т1,  но  заканчивается  состоянием   Т2p. 
Поскольку  адрес для Цикла 2 устанавливается еще до начала Цикла 2, 
последний  называется  конвейерным  циклом  шины  и  начинается   с 
состояния  Т1p.  Цикл 2 начнется, как только активный сигнал READY# 
завершит Цикл 1. Примерами переходных циклов шины являются  Цикл  1 
на  рис.5-17  и  Цикл  2 на рис.5-16. На рис.5-17 показан переход в 
течение цикла шины, первого после нерабочего  состояния  шины,  это 
самый   кратчайший  из  возможных  переходов  в  режим  конвейерной 
адресации. Цикл 2 на  рис.5-16 иллюстрирует переходной  цикл  шины, 
имеющий  место  внутри  последовательности  рабочих  циклов шины. В 
любом случае переходные циклы осуществляются аналогично  независимо 
от момента их появления: переходной цикл состоит по меньшей мере из 
состояний Т1, Т2 (в этот момент вы устанавливаете  активный  сигнал 
NA#),  Т2p (при условии, что 80386 уже имеет ожидающий обслуживания 
внутренний запрос шины,  это  условие  выполняется  почти  всегда). 
Состояния   Т2p  повторяются,  если  цикл  дополняется  состояниями 
ожидания. 
     Отметим три состояния  (Т1,  Т2  и  Т2p),  комбинация  которых 
требуется  только  в  цикле  шины,  выполняющем  переход  из режима 
неконвейерной адресации в режим  конвейерной  адресации,  например, 
Цикл  1  на  рис.5-17. Циклы 2, 3 и 4 на рис.5-17 показывают, что в 
режиме конвейерной адресации могут выполняться циклы шины  из  двух 
состояний каждый, включающие только состояния Т1p и Т2p. 
     Когда  выполняется  конвейерный  цикл  шины, режим конвейерной 
адресации поддерживается путем установки активного  сигнала  NA#  и 
определением  того,  что  80386  устанавливает состояние Т2p шины в 
текущем  цикле  шины.  Текущий  цикл  шины   должен   заканчиваться 
состоянием  Т2p  для  того,  чтобы  режим конвейерной адресации был 
сохранен  и  в  следующем  цикле.  Состояние  Т2p  идентифицируется 
установкой  активного  сигнала  ADS#.  На  рис.5-16  и  5-17  ражим 
конвейерной  адресации  заканчивается  после  Цикла  4,   так   как 
последним  состоянием Цикла 4 является состояние Т2i. Это означает, 
что  80386  не  имел  внутреннего  запроса  шины  перед  получением 
подтверждения  Цикла  4.  Если цикл заканчивается состоянием Т2 или 
Т2i, то следующий цикл будет неконвейерным. 
     В    действительности,    конвейерный   адрес   почти   всегда
устанавливается сразу после обнаружения активного уровня  NA#.  Это
происходит  потому,  что  при  отсутствии  любого  другого  запроса
внутренний запрос  предварительной  выборки  команды  почти  всегда
ожидает  обслуживания  до  тех  пор, пока занят дешифратор команд и
полностью  заполнена  очередь  предварительно   выбранных   команд.
Следовательно,   конвейерный   адрес  устанавливается  для  длинных
цепочек циклов шины, если шина доступна,  и  в  каждом  цикле  шины
оказывается установленным активный уровень сигнала NA#.
     
     
           5.4.3.6  Конвейерная адресация при изменении
                           размера шины данных

     Наличие   сигнала  BS16#  обеспечивает  простое  соединение  с
16-разрядными шинами  данных.  Когда  установлен  активный  уровень
BS16#,  схема  шинного  интерфейса  80386 выполняет соответствующие
переключения, чтобы осуществить  передачу,  используя  16-разрядную
шину данных, соединенную с линиями D0-D15.

                                     - 120 -
           
           
     Однако,  при  одновременном использовании сигналов NA# и BS16#
имеет место некоторое взаимное влияние этих сигналов друг на друга.
Это   взаимное   влияние   проявляется   тогда,   когда   требуются
многократные циклы шины  для  передачи  32-разрядных  операндов  по
16-разрядной   шине.   Если  операнду  требуются  обе  16-разрядные
половины 32-разрядной шины, то в соответствии  с  этим  требованием
80386  должен  выполнить второй цикл шины для того, чтобы полностью
передать весь операнд. Именно это требование приводит к конфликтной
ситуации при использовании сигнала NA#.
     Когда  NA# оказывается установленным в активный уровень, 80386
дает  себе  разрешение   на   обработку   следующего   внутреннего,
ожидающего  обслуживания  запроса  шины  и выдает на шину следующий
подготовленный внутри адрес. Следовательно, активизация NA#  делает
невозможным  повторную  выборку  в  следующем  цикле  шины текущего
адреса по линиям A2-A31, как это может потребоваться, когда  сигнал
BS16# активизирован внешним устройством.
     Для  разрешения  этого конфликта схема 80386 разработана таким
образом, чтобы удовлетворять следующим двум условиям:
     1). Для разрешения конфликта 80386 разработан  таким  образом,
чтобы  игнорировать сигнал BS16# в текущем цикле шины, если NA# уже
оказался  установленным  в  текущем  цикле.   Если   NA#   оказался
установленным,  то текущий размер шины данных принимается равным 32
разрядам.
     2). Также для разрешения конфликта в том случае, если и NA#  и
BS16#  оказались  установленными  в  один  и тот же момент времени,
активный BS16# обладает более высокими по сравнению с активным  NA#
приоритетом, и 80386 функционируется так, как если бы в этот момент
сигнал NA# оказался неактивным. Внутренняя схема 80386,  схематично
показанная  на  рис.5-18 работает таким образом, чтобы сигнал BS16#
воспринимался активным и сигнал NA# воспринимался неактивным,  если
оба  входных  сигнала активизированы внешними устройствами в один и
тот же момент просмотра этих сигналов. 


     5.4.4 Циклы подтверждения прерывания(INTA)

        
В ответ на запрос  прерывания,  поступивший  на  вход  INTR,  когда 
прерывания   разрешены,  80386  выполнит  два  цикла  подтверждения 
прерывания. Эти циклы шины  аналогичны  циклам  чтения,  в  которых 
имеющий   место   вид   деятельности  шины  соответствует  сигналам 
определения типа цикла шины, и каждый цикл продолжается до тех пор, 
пока  процессор  не  получит  подтверждение,  наблюдая  за сигналом 
READY#. 
     В зависимости от значения  адресного  разряда  А2  различаются 
первый  и  второй  циклы  подтверждения  прерывания.  Адрес  байта, 
выдаваемый в первом цикле подтверждения прерывания, равен 4 (А31-А3 
низкие,  А2  высокий,  ВЕ3#-ВЕ1#  высокие  и  ВЕ0#  низкий). Адрес, 
выдаваемый  во  втором  цикле  подтверждения  прерывания,  равен  0 
(А31-А2 низкие, ВЕ3#-ВЕ1# высокие, ВЕ0# низкий). 
     Активный   уровень  сигнала  LOCK#  устанавливается  с  начала 
первого цикла подтверждения прерывания и  до  конца  второго  цикла 
подтверждения  прерывания.  Четыре  нерабочих  состояния  шины, Тi, 
вставляются   процессором   между   двумя   циклами   подтверждения 
прерывания,   чтобы   обеспечить  время  блокированного  нерабочего 
состояния шины ("мертвое" время) по меньшей мере длительностью  160 
нс,  что  позволит  в  будущем  ввести  модификации скорости 80386, 
достигающие 24 МГц (при этом внешняя частота CLK2 должна  достигать 
48  МГц),  что  в  свою очередь обеспечит совместимость с временным 
параметром TRHRL контроллера прерываний 8259А.
 
                                     - 122 -
           
           
     В течение обоих циклов подтверждения прерывания  линии  D0-D31 
отключены.В конце первого цикла подтверждения прерывания данных для 
чтения не имеется. В конце второго цикла  подтверждения  прерывания 
80386  считает  внешний  вектор  прерывания  по  линиям  D0-D7 шины 
данных. Вектор указывает определенный номер  прерывания  (от  0  до 
255), требующего обслуживания. 
     
     
     
     5.4.5 Цикл индикации останова
     
     
     80386 останавливается в результате выполнения инструкции HALT. 
Для  сигнализирования  входа  процессора   в   состояние   останова 
выполняется   цикл  индикации  останова.  Цикл  индикации  останова 
идентифицируется определенной комбинацией сигналов типа цикла шины, 
указанной  в  разделе 5.2.5 Сигналы определения типа цикла  шины, и 
адресом байта, равным 2. ВЕ0# и ВЕ2# при  этом  служат  только  для 
различения  цикла индикации останова от цикла индикации выключения, 
в котором выдается  адрес,  равный  0.  В  течение  цикла  останова 
данные, передаваемые по D0-D31, неопределены. 
     Остановленный  80386  возобновляет   функционирование,   когда
устанавливается  активный  уровень  сигнала  INTR  (если прерывания
разрешены), или сигнала NMI, или сигнала RESET.
     
     
     
     5.4.6 Цикл индикации выключения 
     
     
     80386 выключается в результате появления ошибки защиты  памяти
при   попытке   обработать  двойную  ошибку.  Для  сигнализирования
перехода  процессора  в  выключенное  состояние  выполняется   цикл
индикации  выключения.  Цикл  индикации выключения идентифицируется
определенной комбинацией  сигналов  определения  типа  цикла  шины,
указанной  в  разделе  5.2.5 Сигналы определения типа цикла шины, и
адресом байта, равным 0. Сигналы ВЕ0# и ВЕ2# при этом служат только
для   отличения  цикла  индикации  выключения  от  цикла  индикации
останова, в котором выдается  адрес,  равный  2.  В  течение  цикла
выключения данные,  выдаваемые  на линии D0-D31, неопределены. Цикл
индикации выключения должен быть подтвержден  установкой  активного
уровня сигнала READY#. 
     Выключенный   80386   возобновляет   функционирование,   когда
устанавливается активный уровень сигнала NMI или RESET.
     
     
     
     5.5 Дополнительные сведения о функционировании
     
     
     5.5.1 Вход и выход в/из состояния подтверждения захвата шины
     
     
     Состояние  подтверждения захвата шины, Тh, вводится в ответ на 
установку активного  уровня  входного  сигнала  HOLD.  В  состоянии 
подтверждения   захвата  шины  80386  выключает  все  выходные  или 
двунаправленные сигналы, исключая  сигнал  HLDA.  Активный  уровень 
сигнала HLDA поддерживается все время, пока 80386 находится в 

                                     - 125 -
           
           
состоянии  подтверждения  захвата  шины.  В состоянии подтверждения 
захвата шины все входы, за исключением HOLD и  RESET,  игнорируются 
(исключение  составляет также один положительный фронт сигнала NMI, 
который запоминается для последующей его  обработки,  когда  сигнал 
HOLD перейдет в неактивное состояние). 
     Состояние  Th  может  быть  введено после нерабочего состояния
шины, как на рис.5-25, или после подтверждения текущего физического
цикла  шины, если при этом уровень сигнала LOCK# неактивный, как на
рис.5-26 и 5-27. Если установка  активного  сигнала  ВS16#  требует
выполнения второго 16-разрядного цикла шины для завершения передачи
физического операнда, то этот  цикл  выполняется  до  подтверждения
сигнала  HOLD,  хотя  диаграммы  состояний  на  рис.5-13  и 5-20 не
отражают этой особенности.
     Выход  из  состояния  Th  осуществляется  в  ответ  на  снятие
активного  уровня входного сигнала HOLD. Следующим состоянием будет
состояние  Ti,  как  на  рис.5-25,  если  не   имеется   ожидающего
обслуживания  внутреннего запроса шины. Если же имеется внутренний,
ожидающий решения запрос шины, то следующим состоянием  шины  будет
состояние Т1, как показано на рис.5-26 и 5-27. 
     Выход   из  состояния  Th  осуществляется  также  в  ответ  на
установку активного уровня сигнала RESET. 
     Если в течение состояния Th появится  положительный  фронт  на
чувствительном  к фронту входе NMI, то это событие запоминается как
немаскируемое прерывание 2 и обслуживается после выхода  процессора
из  состояния  Th  кроме  случая,  когда до выхода из Th произойдет
сброс 80386.
     
     
     
     5.5.2 Сброс в состоянии подтверждения захвата шины
     
     
     Активный сигнал RESET обладает более  высоким  приоритетом  по
сравнению  с  активным  сигналом  HOLD.  Следовательно,  в ответ на
установку активного уровня на входе RESET осуществляется  выход  из
состояния  Th.  Если  сигнал RESET активизируется во время действия
сигнала  HOLD,  то  80386  установит  свои  выводы  в  определенные
состояния  в  соответствии  с табл.5-3 "Состояния выводов в течение
действия сигнала RESET" и выполнит  обычную  процедуру  внутреннего
сброса.
     Если  активный  уровень  сигнала HOLD остается установленным и
после снятия активного сигнала RESET, то 80386 перейдет в состояние
подтверждения  захвата  шины до того, как выполнит свой первый цикл
шины, но при условии, что HOLD все еще остается активным в  момент,
когда  80386  в  другом  случае  приступил  бы  к выполнению своего
первого цикла  шины.  Если  HOLD  остается  активным  после  снятия
сигнала  RESET,  то  вход BUSY# все равно анализируется как обычно,
чтобы определить требуется ли самотестирование, сигнал ERROR# также
при  этом анализируется как обычно, чтобы определить, какой из двух
воэможных  сопроцессоров  присутствует   в   системе   (или   когда
сопроцессора вобще нет).    

                                     - 129 -
     
     
     5.5.3  Функционирование  шины  в  течение  и  после   действия
                            сигнала RESET 

     
  RESET   является   самым   приоритетным   входным  сигналом,  при
установке активного уровня  RESET  прерывается  любая  деятельность
процессора.  Выполняемый  цикл  шины может быть прерванным на любой
стадии,  а  нерабочие состояния или состояния подтверждения захвата
шины прекращаются при установке состояния сброса.
     RESET должен поддерживаться в активном состоянии в течение  по
меньшей мере 15 периодов частоты CLK2, чтобы он был уверенно принят
всеми схемами 80386, и по меньшей мере в течение 78 периодов  CLK2,
если   выполняется   самотестирование   80386,  запрос  на  которое
анализируется во время отрицательного фронта RESET.
     Активные импульсы RESET длительностью меньше 15 периодов  CLK2
могут быть не восприняты.
     Активные импульсы RESET длительностью меньше 78 периодов CLK2,
за которыми следует самотестирование, могут привести  к  тому,  что
тест-структура   выдаст   сообщение   о   неисправности,   когда  в
действительности  неисправности   не   существует.   Дополнительное
расширение  импульса  RESET  необходимо  для  получения достоверных
результатов самодиагностирования.
     При  условии,   что   отрицательный   фронт   RESET   отвечает
требованиям,  предъявляемым  к  времени  установки  t25  и  времени
удержания  t26,  этот  фронт  определит  фазу  внутренней  тактовой
частоты процессора, как показано на рис.5-28 и рис.7-7.
     Самодиагностирование  80386 можно запустить, если поддерживать
сигнал BUSY# на низком уровне в момент снятия  сигнала  RESET,  как
показано    на    рис.5-28.    Для    выполнения   всей   процедуры
самодиагностирования требуется [(2^20)+ приблизительно 60] периодов
CLK2.   Результаты  тестирования  не  влияют  на  продолжительность
самодиагностирования.
     Даже  если  после  тестирования  тест-структура  указывает  на
наличие  неисправности,  80386  все  равно  перейдет  к  выполнению
процедуры, которая должна была следовать за сбросом 80386.
     После  отрицательного  фронта RESET (и после самотестирования,
если в нем была необходимость)  80386  выполнит  последовательность
внутренней  инициализации  за  время, приблизительно равное 350-450
периодам CLK2. Во время  инициализации,  между  двадцатым  периодом
CLK2  и  первым  циклом шины (который последует за инициализацией),
80386 анализирует состояние входа  ERROR#,  чтобы  отличить  случай
присутсвия   в   системе   сопроцессора   80387  от  случая,  когда
присутствует  80287  или  в  системе  вобще  нет   сопропроцессора.
Различие  между  последними  двумя случаями (в системе присутствует
80287 или в системе нет сопроцессора) задается программно. 
     
      
   
                 5.6 Сигнатура самотестирования
       
     
По  завершению   самотестирования   (если   самотестирование   было
запрошено  путем  поддержания низкого уровня сигнала BUSY# во время
отрицательного  фронта  сигнала  RESET),  если  не  было обнаружено
неисправностей 80386, то значение каждого  из  регистров  AX  и  DX
будет  равно  0000H.  Это  справедливо  для всех модификаций 80386.
Ненулевые значения  регистров  AX  или  DX  после  самотестирования
указывает на то, что какой-то блок 80386 неисправен.

                                     - 131 -
     

     5.7 Идентификаторы типа и модификации
     
     Чтобы   помочь   пользователям   80386,   80386  после  сброса
поддерживает  идентификатор  типа   и   идентификатор   модификации
соответственно   в   регистрах   BH  и  BL.  BH  содержит  03H  для
идентификации типа 80386. BL содержит беззнаковое  двоичное  число,
соответствующее   версии   данного   типа   процессора.  Хронология
изменения идентификатора модификации (версии) 80386 в BL такова: он
начинается   с   нуля   и  изменяется  (обычно  увеличивается)  при
изменениях   данного   типа   процессора,    предназначенных    для
усовершенствования   данного   типа   процессора   по  сравнению  с
предыдущими версиями.
     Эти  особенности  предназначены   для   того,   чтобы   помочь
пользователям  80386  в  их  практической  деятельности.  Однако не
гарантируется, что значение идентификатора версии будет  изменяться
с  каждым  изменением  версии  или  что  изменения этого значения в
зависимости от содержания или цели  версии  или  в  зависимости  от
материалов,  требующих  изменения,  будут   следовать   строго   по
непрерывной  числовой  последовательности.  Фирма Intel поступает с
этими характеристиками данного типа  процессора  только  по  своему
усмотрению.
     
     Табл.5-10 История идентификаторов типа и версии
     
-------------------------------------------------------------------
Содержа-  |Идентифи- |Идентифи- |Содержа-  |Идентифи- |Идентифи-   
ние изме- |катор ти- |катор     |ние изме- |катор ти- |катор
нения     |па        |версии    |нения     |па        |версии
80386     |          |          |80386     |          |
          |          |          |          |          |
-------------------------------------------------------------------
          |          |          |          |          |

              